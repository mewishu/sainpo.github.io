<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: 'search.xml'
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="码农|理工男|文青">
<meta property="og:type" content="website">
<meta property="og:title" content="窦小固的小木屋">
<meta property="og:url" content="http://www.sainpo.top/index.html">
<meta property="og:site_name" content="窦小固的小木屋">
<meta property="og:description" content="码农|理工男|文青">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="窦小固的小木屋">
<meta name="twitter:description" content="码农|理工男|文青">
  <link rel="canonical" href="http://www.sainpo.top/">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>窦小固的小木屋</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">窦小固的小木屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">西河书生</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">
      
    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
        <li class="menu-item menu-item-search">
          <a href="javascript:;" class="popup-trigger">
          
            <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>


    </div>
</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/15/zookeeper-leader-election/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/15/zookeeper-leader-election/" class="post-title-link" itemprop="url">zookeeper选举算法</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-15 19:54:10 / 修改时间：21:28:54" itemprop="dateCreated datePublished" datetime="2019-08-15T19:54:10+08:00">2019-08-15</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/分布式一致性/" itemprop="url" rel="index"><span itemprop="name">分布式一致性</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/分布式一致性/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">37k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">34 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="时机"><a href="#时机" class="headerlink" title="时机"></a>时机</h3><p>Leader选举是保证分布式数据一致性的关键所在。当Zookeeper集群中的一台服务器出现以下两种情况之一时，需要进入Leader选举: </p>
<p>　　(1) 服务器初始化启动。</p>
<p>　　(2) 服务器运行期间无法和Leader保持连接。</p>
<p>在Zookeeper运行期间，Leader与非Leader服务器各司其职，即便当有非Leader服务器宕机或新加入，此时也不会影响Leader，但是一旦Leader服务器挂了，那么整个集群将暂停对外服务，进入新一轮Leader选举，其过程和启动时期的Leader选举过程基本一致。假设正在运行的有Server1、Server2、Server3三台服务器，当前Leader是Server2，若某一时刻Leader挂了，此时便开始Leader选举。</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>若进行Leader选举，则至少需要两台机器，这里选取3台机器组成的服务器集群为例。在集群初始化阶段，当有一台服务器Server1启动时，其单独无法进行和完成Leader选举，当第二台服务器Server2启动时，此时两台机器可以相互通信，每台机器都试图找到Leader，于是进入Leader选举过程。Leader 选举过程，本质就是广播<code>优先级消息</code>的过程，选出<strong>数据最新的服务节点</strong>，选出<strong>优先级最高的服务节点</strong>，基本步骤：</p>
<ol>
<li><p><strong>每个Server发出一个投票</strong>。Server1和Server2都会将自己作为Leader服务器来进行投票，广播自己的优先级标识 <code>(sid，zxid)</code>。例如服务器启动时，此时Server1的投票为(1, 0)，Server2的投票为(2, 0)，然后各自将这个投票发给集群中其他机器。</p>
</li>
<li><p><strong>接受来自各个服务器的投票</strong>。集群的每个服务器收到投票后，首先判断该投票的有效性，如检查是否是本轮投票、是否来自LOOKING状态的服务器。</p>
</li>
<li><p><strong>处理投票</strong>。服务器节点收到其他广播消息后，跟自己的优先级对比，自己优先级低，则变更当前节点投票的优先级<code>(sid，zxid)</code> ，并广播变更后的结果，优先级PK规则: </p>
<ol>
<li>优先比较 <code>zxid</code> （事务 ID），其次比较<code>sid</code>（服务器ID）</li>
<li><code>sid</code> (服务器 ID) 是节点配置文件中设定的</li>
</ol>
<p>对于Server1而言，它的投票是(1, 0)，接收Server2的投票为(2, 0)，首先会比较两者的ZXID，均为0，再比较myid，此时Server2的myid最大，于是更新自己的投票为(2, 0)，然后重新投票，对于Server2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次投票信息即可。</p>
</li>
<li><p><strong>统计投票</strong>。当任意一个服务器节点收到的投票数，超过了<code>法定数量</code>(quorum)亦即集群规模大小的半数以上，则升级为 Leader，并广播结果。对于Server1、Server2而言，都统计出集群中已经有两台机器接受了(2, 0)的投票信息，此时便认为已经选出了Leader。</p>
</li>
<li><p><strong>改变服务器状态</strong>。一旦确定了Leader，每个服务器就会更新自己的状态，如果是Follower，那么就变更为FOLLOWING，如果是Leader，就变更为LEADING。</p>
</li>
</ol>
<h2 id="Leader选举算法分析"><a href="#Leader选举算法分析" class="headerlink" title="Leader选举算法分析"></a>Leader选举算法分析</h2><p>在3.4.0后的Zookeeper的版本只保留了TCP版本的FastLeaderElection选举算法。当一台机器进入Leader选举时，当前集群可能会处于以下两种状态</p>
<p>　　· 集群中已经存在Leader。</p>
<p>　　· 集群中不存在Leader。</p>
<p>对于集群中已经存在Leader而言，此种情况一般都是某台机器启动得较晚，在其启动之前，集群已经在正常工作，对这种情况，该机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器而言，仅仅需要和Leader机器建立起连接，并进行状态同步即可。而在集群中不存在Leader情况下则会相对复杂，其步骤如下:</p>
<h3 id="第一次投票"><a href="#第一次投票" class="headerlink" title="第一次投票"></a><strong>第一次投票</strong></h3><p>无论哪种导致进行Leader选举，集群的所有机器都处于试图选举出一个Leader的状态，即LOOKING状态，LOOKING机器会向所有其他机器发送消息，该消息称为投票。投票中包含了(sid，zxid) 形式来标识一次投票信息。假定Zookeeper由5台机器组成，<code>sid</code>分别为1、2、3、4、5，<code>zxid</code>分别为9、9、9、8、8，并且此时<code>sid</code>为2的机器是Leader机器，某一时刻，1、2所在机器出现故障，因此集群开始进行Leader选举。在第一次投票时，每台机器都会将自己作为投票对象，于是<code>sid</code>为3、4、5的机器投票情况分别为(3, 9)，(4, 8)， (5, 8)。</p>
<h3 id="变更投票"><a href="#变更投票" class="headerlink" title="变更投票"></a><strong>变更投票</strong></h3><p>每台机器发出投票后，也会收到其他机器的投票，每台机器会根据一定规则来处理收到的其他机器的投票，并以此来决定是否需要变更自己的投票，这个规则也是整个Leader选举算法的核心所在，其中术语描述如下: </p>
<p>　　　　<strong>· vote_sid</strong>：接收到的投票中所推举Leader服务器的<code>sid</code>。</p>
<p>　　　　<strong>· vote_zxid</strong>：接收到的投票中所推举Leader服务器的<code>zxid</code>。</p>
<p>　　　　<strong>· self_sid</strong>：当前服务器自己的<code>sid</code>。</p>
<p>　　　　<strong>· self_zxid</strong>：当前服务器自己的<code>zxid</code>。</p>
<p>　　每次对收到的投票的处理，都是对(vote_sid, vote_zxid)和(self_sid, self_zxid)对比的过程。</p>
<p>　　　　规则一：如果vote_zxid大于self_zxid，就认可当前收到的投票，并再次将该投票发送出去。</p>
<p>　　　　规则二：如果vote_zxid小于self_zxid，那么坚持自己的投票，不做任何变更。</p>
<p>　　　　规则三：如果vote_zxid等于self_zxid，那么就对比两者的SID，如果vote_sid大于self_sid，那么就认可当前收到的投票，并再次将该投票发送出去。</p>
<p>　　　　规则四：如果vote_zxid等于self_zxid，并且vote_sid小于self_sid，那么坚持自己的投票，不做任何变更。</p>
<p>　　结合上面规则，给出下面的集群变更过程。</p>
<p><img src="/2019/08/15/zookeeper-leader-election/616953-20161202213100568-693960760.png" alt="Lead选举集群变更过程"></p>
<h3 id="确定Leader"><a href="#确定Leader" class="headerlink" title="确定Leader"></a>确定Leader</h3><p>经过第二轮投票后，集群中的每台机器都会再次接收到其他机器的投票，然后开始统计投票，如果一台机器收到了超过半数的相同投票，那么这个投票对应的SID机器即为Leader。此时Server3将成为Leader。</p>
<p>由上面规则可知，通常那台服务器上的数据越新（<code>zxid</code>会越大），其成为Leader的可能性越大，也就越能够保证数据的恢复。如果<code>zxid</code>相同，则<code>sid</code>越大机会越大。</p>
<h2 id="Leader选举实现细节"><a href="#Leader选举实现细节" class="headerlink" title="Leader选举实现细节"></a>Leader选举实现细节</h2><h3 id="服务器状态"><a href="#服务器状态" class="headerlink" title="服务器状态"></a>服务器状态</h3><p>服务器具有四种状态，分别是LOOKING、FOLLOWING、LEADING、OBSERVING。</p>
<p><strong>LOOKING</strong>：寻找Leader状态。当服务器处于该状态时，它会认为当前集群中没有Leader，因此需要进入Leader选举状态。</p>
<p><strong>FOLLOWING</strong>：跟随者状态。表明当前服务器角色是Follower。</p>
<p><strong>LEADING</strong>：领导者状态。表明当前服务器角色是Leader。</p>
<p><strong>OBSERVING</strong>：观察者状态。表明当前服务器角色是Observer。</p>
<h3 id="投票数据结构"><a href="#投票数据结构" class="headerlink" title="投票数据结构"></a>投票数据结构</h3><p>每个投票中包含了两个最基本的信息，所推举服务器的<code>sid</code>和<code>zxid</code>，投票（Vote）在Zookeeper中包含字段如下</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">id</td>
<td align="left">被推举 Leader 的 <code>sid</code></td>
</tr>
<tr>
<td align="left">zxid</td>
<td align="left">被推举 Leader 的<code>zxid</code></td>
</tr>
<tr>
<td align="left">electionEpoch</td>
<td align="left">投票的轮次，逻辑时钟，用来判断多个投票是否在同一轮选举周期中，该值在服务端是一个自增序列，每次进入新一轮的投票后，都会对该值进行加1操作</td>
</tr>
<tr>
<td align="left">peerEpoch</td>
<td align="left">被推举 Leader 的 epoch</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">当前服务器的状态</td>
</tr>
</tbody></table>
<p>一次 Leader 选举过程，属于同一个 <code>electionEpoch</code>，结束时，会选出新的 Leader；服务器节点，在比较 <code>(sid，zxid)</code> 之前，会先比较选举轮次 <code>electionEpoch</code>，只有同一轮次的 Leader 投票信息才是有效的：</p>
<ol>
<li>外部投票轮次 &gt; 内部投票轮次，更新内部投票，并且触发当前节点投票信息的<strong>重新广播</strong></li>
<li>外部投票轮次 &lt; 内部投票轮次，直接忽略当前的外部投票</li>
<li>外部投票轮次 = 内部投票轮次，进一步比较 <code>(sid，zxid)</code></li>
</ol>
<p>疑问：Leader 负责执行所有的事务操作，一次事务操作，</p>
<ol>
<li>Leader 如何将事务操作同步到 Follower 和 Observer ？同步、异步？</li>
<li>如何保证同步过程中，事务一定执行成功？事务失败的影响？</li>
</ol>
<p>Leader 上执行的事务状态，通过 <code>Zab</code> 状态更新的广播协议，更新到 Follower 和 Observer。</p>
<h3 id="QuorumCnxManager：网络I-O"><a href="#QuorumCnxManager：网络I-O" class="headerlink" title="QuorumCnxManager：网络I/O"></a>QuorumCnxManager：网络I/O</h3><p>每台服务器在启动的过程中，会启动一个QuorumPeerManager，负责各台服务器之间的底层Leader选举过程中的网络通信。</p>
<h4 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h4><p>QuorumCnxManager内部维护了一系列的队列，用来保存接收到的、待发送的消息以及消息的发送器，除接收队列以外，其他队列都按照SID分组形成队列集合，如一个集群中除了自身还有3台机器，那么就会为这3台机器分别创建一个发送队列，互不干扰。</p>
<p>　　<strong>· recvQueue</strong>：消息接收队列，用于存放那些从其他服务器接收到的消息。</p>
<p>　　<strong>· queueSendMap</strong>：消息发送队列，用于保存那些待发送的消息，按照<code>sid</code>进行分组。</p>
<p>　　<strong>· senderWorkerMap</strong>：发送器集合，每个SenderWorker消息发送器，都对应一台远程Zookeeper服务器，负责消息的发送，也按照SID进行分组。</p>
<p>　　<strong>· lastMessageSent</strong>：最近发送过的消息，为每个<code>sid</code>保留最近发送过的一个消息。</p>
<h4 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h4><p>为了能够相互投票，Zookeeper集群中的所有机器都需要两两建立起网络连接。QuorumCnxManager在启动时会创建一个ServerSocket来监听Leader选举的通信端口(默认为3888)。开启监听后，Zookeeper能够不断地接收到来自其他服务器的创建连接请求，在接收到其他服务器的TCP连接请求时，会进行处理。为了避免两台机器之间重复地创建TCP连接，Zookeeper只允许<code>sid</code>大的服务器主动和其他机器建立连接，否则断开连接。在接收到创建连接请求后，服务器通过对比自己和远程服务器的<code>sid</code>值来判断是否接收连接请求，如果当前服务器发现自己的<code>sid</code>更大，那么会断开当前连接，然后自己主动和远程服务器建立连接。一旦连接建立，就会根据远程服务器的SID来创建相应的消息发送器SendWorker和消息接收器RecvWorker，并启动。</p>
<h4 id="消息接收与发送"><a href="#消息接收与发送" class="headerlink" title="消息接收与发送"></a>消息接收与发送</h4><p><strong>消息接收</strong>：由消息接收器RecvWorker负责，由于Zookeeper为每个远程服务器都分配一个单独的RecvWorker，因此，每个RecvWorker只需要不断地从这个TCP连接中读取消息，并将其保存到recvQueue队列中。</p>
<p><strong>消息发送</strong>：由于Zookeeper为每个远程服务器都分配一个单独的SendWorker，因此，每个SendWorker只需要不断地从对应的消息发送队列中获取出一个消息发送即可，同时将这个消息放入lastMessageSent中。在SendWorker中，一旦Zookeeper发现针对当前服务器的消息发送队列为空，那么此时需要从lastMessageSent中取出一个最近发送过的消息来进行再次发送，这是为了解决接收方在消息接收前或者接收到消息后服务器挂了，导致消息尚未被正确处理。同时，Zookeeper能够保证接收方在处理消息时，会对重复消息进行正确的处理。</p>
<h3 id="FastLeaderElection：选举算法核心"><a href="#FastLeaderElection：选举算法核心" class="headerlink" title="FastLeaderElection：选举算法核心"></a>FastLeaderElection：选举算法核心</h3><h4 id="选票管理"><a href="#选票管理" class="headerlink" title="选票管理"></a>选票管理</h4><p>　　<strong>· sendqueue</strong>：选票发送队列，用于保存待发送的选票。</p>
<p>　　<strong>· recvqueue</strong>：选票接收队列，用于保存接收到的外部投票。</p>
<p>　　<strong>· WorkerReceiver</strong>：选票接收器。其会不断地从QuorumCnxManager中获取其他服务器发来的选举消息，并将其转换成一个选票，然后保存到recvqueue中，在选票接收过程中，如果发现该外部选票的选举轮次小于当前服务器的，那么忽略该外部投票，同时立即发送自己的内部投票。</p>
<p>　　<strong>· WorkerSender</strong>：选票发送器，不断地从sendqueue中获取待发送的选票，并将其传递到底层QuorumCnxManager中。</p>
<h4 id="算法核心"><a href="#算法核心" class="headerlink" title="算法核心"></a>算法核心</h4><p><img src="/2019/08/15/zookeeper-leader-election/616953-20161206114702772-1120304539.png" alt="FastLeaderElection模块是如何与底层网络I/O进行交互"></p>
<p>上图展示了FastLeaderElection模块是如何与底层网络I/O进行交互的。Leader选举的基本流程如下: </p>
<ol>
<li><p><strong>自增选举轮次</strong>。Zookeeper规定所有有效的投票都必须在同一轮次中，在开始新一轮投票时，会首先对logicalclock进行自增操作。</p>
</li>
<li><p><strong>初始化选票</strong>。在开始进行新一轮投票之前，每个服务器都会初始化自身的选票，并且在初始化阶段，每台服务器都会将自己推举为Leader。</p>
</li>
<li><p><strong>发送初始化选票</strong>。完成选票的初始化后，服务器就会发起第一次投票。Zookeeper会将刚刚初始化好的选票放入sendqueue中，由发送器WorkerSender负责发送出去。</p>
</li>
<li><p><strong>接收外部投票</strong>。每台服务器会不断地从recvqueue队列中获取外部选票。如果服务器发现无法获取到任何外部投票，那么就会立即确认自己是否和集群中其他服务器保持着有效的连接，如果没有连接，则马上建立连接，如果已经建立了连接，则再次发送自己当前的内部投票。</p>
</li>
<li><p><strong>判断选举轮次</strong>。在发送完初始化选票之后，接着开始处理外部投票。在处理外部投票时，会根据选举轮次来进行不同的处理。</p>
</li>
</ol>
<p>　　<strong>· 外部投票的选举轮次大于内部投票</strong>。若服务器自身的选举轮次落后于该外部投票对应服务器的选举轮次，那么就会立即更新自己的选举轮次(logicalclock)，并且清空所有已经收到的投票，然后使用初始化的投票来进行PK以确定是否变更内部投票。最终再将内部投票发送出去。</p>
<p>　　<strong>· 外部投票的选举轮次小于内部投票</strong>。若服务器接收的外选票的选举轮次落后于自身的选举轮次，那么Zookeeper就会直接忽略该外部投票，不做任何处理，并返回步骤4。</p>
<p>　　<strong>· 外部投票的选举轮次等于内部投票</strong>。此时可以开始进行选票PK。</p>
<ol start="6">
<li><strong>选票PK</strong>。在进行选票PK时，符合任意一个条件就需要变更投票。</li>
</ol>
<p>　　　　· 若外部投票中推举的Leader服务器的选举轮次大于内部投票，那么需要变更投票。</p>
<p>　　　　· 若选举轮次一致，那么就对比两者的ZXID，若外部投票的ZXID大，那么需要变更投票。</p>
<p>　　　　· 若两者的ZXID一致，那么就对比两者的SID，若外部投票的SID大，那么就需要变更投票。</p>
<ol start="7">
<li><p><strong>变更投票</strong>。经过PK后，若确定了外部投票优于内部投票，那么就变更投票，即使用外部投票的选票信息来覆盖内部投票，变更完成后，再次将这个变更后的内部投票发送出去。</p>
</li>
<li><p><strong>选票归档</strong>。无论是否变更了投票，都会将刚刚收到的那份外部投票放入选票集合recvset中进行归档。recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票（按照服务队的SID区别，如{(1, vote1), (2, vote2)…}）。</p>
</li>
<li><p><strong>统计投票</strong>。完成选票归档后，就可以开始统计投票，统计投票是为了统计集群中是否已经有过半的服务器认可了当前的内部投票，如果确定已经有过半服务器认可了该投票，则终止投票。否则返回步骤4。</p>
</li>
<li><p><strong>更新服务器状态</strong>。若已经确定可以终止投票，那么就开始更新服务器状态，服务器首选判断当前被过半服务器认可的投票所对应的Leader服务器是否是自己，若是自己，则将自己的服务器状态更新为LEADING，若不是，则根据具体情况来确定自己是FOLLOWING或是OBSERVING。</p>
</li>
</ol>
<p>　　以上10个步骤就是FastLeaderElection的核心，其中步骤4-9会经过几轮循环，直到有Leader选举产生。</p>
<h2 id="FastLeaderElection源码分析"><a href="#FastLeaderElection源码分析" class="headerlink" title="FastLeaderElection源码分析"></a>FastLeaderElection源码分析</h2><p>　　2.1 类的继承关系　</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class FastLeaderElection implements Election &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>　　说明：FastLeaderElection实现了Election接口，其需要实现接口中定义的lookForLeader方法和shutdown方法，其是标准的Fast Paxos算法的实现，各服务器之间基于TCP协议进行选举。</p>
<p>　　2.2 类的内部类</p>
<p>　　FastLeaderElection有三个较为重要的内部类，分别为Notification、ToSend、Messenger。</p>
<p>　　1. Notification类　</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">static public class Notification &#123;</span><br><span class="line">    /*</span><br><span class="line">     * Format version, introduced in 3.4.6</span><br><span class="line">     */</span><br><span class="line">    </span><br><span class="line">    public final static int CURRENTVERSION = 0x1; </span><br><span class="line">    int version;</span><br><span class="line">            </span><br><span class="line">    /*</span><br><span class="line">     * Proposed leader</span><br><span class="line">     */</span><br><span class="line">    // 被推选的leader的id</span><br><span class="line">    long leader;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * zxid of the proposed leader</span><br><span class="line">     */</span><br><span class="line">    // 被推选的leader的事务id</span><br><span class="line">    long zxid;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Epoch</span><br><span class="line">     */</span><br><span class="line">    // 推选者的选举周期</span><br><span class="line">    long electionEpoch;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * current state of sender</span><br><span class="line">     */</span><br><span class="line">    // 推选者的状态</span><br><span class="line">    QuorumPeer.ServerState state;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Address of sender</span><br><span class="line">     */</span><br><span class="line">    // 推选者的id</span><br><span class="line">    long sid;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * epoch of the proposed leader</span><br><span class="line">     */</span><br><span class="line">    // 被推选者的选举周期</span><br><span class="line">    long peerEpoch;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return new String(Long.toHexString(version) + &quot; (message format version), &quot; </span><br><span class="line">                + leader + &quot; (n.leader), 0x&quot;</span><br><span class="line">                + Long.toHexString(zxid) + &quot; (n.zxid), 0x&quot;</span><br><span class="line">                + Long.toHexString(electionEpoch) + &quot; (n.round), &quot; + state</span><br><span class="line">                + &quot; (n.state), &quot; + sid + &quot; (n.sid), 0x&quot;</span><br><span class="line">                + Long.toHexString(peerEpoch) + &quot; (n.peerEpoch) &quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static ByteBuffer buildMsg(int state,</span><br><span class="line">        long leader,</span><br><span class="line">        long zxid,</span><br><span class="line">        long electionEpoch,</span><br><span class="line">        long epoch) &#123;</span><br><span class="line">    byte requestBytes[] = new byte[40];</span><br><span class="line">    ByteBuffer requestBuffer = ByteBuffer.wrap(requestBytes);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Building notification packet to send </span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    requestBuffer.clear();</span><br><span class="line">    requestBuffer.putInt(state);</span><br><span class="line">    requestBuffer.putLong(leader);</span><br><span class="line">    requestBuffer.putLong(zxid);</span><br><span class="line">    requestBuffer.putLong(electionEpoch);</span><br><span class="line">    requestBuffer.putLong(epoch);</span><br><span class="line">    requestBuffer.putInt(Notification.CURRENTVERSION);</span><br><span class="line">    </span><br><span class="line">    return requestBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：Notification表示收到的选举投票信息（其他服务器发来的选举投票信息），其包含了被选举者的id、zxid、选举周期等信息，其buildMsg方法将选举信息封装至ByteBuffer中再进行发送。</p>
<p>　　2. ToSend类　　</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">static public class ToSend &#123;</span><br><span class="line">    static enum mType &#123;crequest, challenge, notification, ack&#125;</span><br><span class="line"></span><br><span class="line">    ToSend(mType type,</span><br><span class="line">            long leader,</span><br><span class="line">            long zxid,</span><br><span class="line">            long electionEpoch,</span><br><span class="line">            ServerState state,</span><br><span class="line">            long sid,</span><br><span class="line">            long peerEpoch) &#123;</span><br><span class="line"></span><br><span class="line">        this.leader = leader;</span><br><span class="line">        this.zxid = zxid;</span><br><span class="line">        this.electionEpoch = electionEpoch;</span><br><span class="line">        this.state = state;</span><br><span class="line">        this.sid = sid;</span><br><span class="line">        this.peerEpoch = peerEpoch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Proposed leader in the case of notification</span><br><span class="line">     */</span><br><span class="line">    //被推举的leader的id</span><br><span class="line">    long leader;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * id contains the tag for acks, and zxid for notifications</span><br><span class="line">     */</span><br><span class="line">    // 被推举的leader的最大事务id</span><br><span class="line">    long zxid;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Epoch</span><br><span class="line">     */</span><br><span class="line">    // 推举者的选举周期</span><br><span class="line">    long electionEpoch;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Current state;</span><br><span class="line">     */</span><br><span class="line">    // 推举者的状态</span><br><span class="line">    QuorumPeer.ServerState state;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Address of recipient</span><br><span class="line">     */</span><br><span class="line">    // 推举者的id</span><br><span class="line">    long sid;</span><br><span class="line">    </span><br><span class="line">    /*</span><br><span class="line">     * Leader epoch</span><br><span class="line">     */</span><br><span class="line">    // 被推举的leader的选举周期</span><br><span class="line">    long peerEpoch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：ToSend表示发送给其他服务器的选举投票信息，也包含了被选举者的id、zxid、选举周期等信息。</p>
<p>　　3. Messenger类</p>
<p>　　3.1 类的内部类</p>
<p>　　Messenger包含了WorkerReceiver和WorkerSender两个内部类</p>
<p>　　1. WorkerReceiver　　</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="img"> WorkerReceiver</p>
<p>　　说明：WorkerReceiver实现了Runnable接口，是选票接收器。其会不断地从QuorumCnxManager中获取其他服务器发来的选举消息，并将其转换成一个选票，然后保存到recvqueue中，在选票接收过程中，如果发现该外部选票的选举轮次小于当前服务器的，那么忽略该外部投票，同时立即发送自己的内部投票。其是将QuorumCnxManager的Message转化为FastLeaderElection的Notification。</p>
<p>　　其中，WorkerReceiver的主要逻辑在run方法中，其首先会从QuorumCnxManager中的recvQueue队列中取出其他服务器发来的选举消息，消息封装在Message数据结构中。然后判断消息中的服务器id是否包含在可以投票的服务器集合中，若不是，则会将本服务器的内部投票发送给该服务器，其流程如下　　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if(!self.getVotingView().containsKey(response.sid))&#123; // 当前的投票者集合不包含服务器</span><br><span class="line">    // 获取自己的投票</span><br><span class="line">    Vote current = self.getCurrentVote();</span><br><span class="line">    // 构造ToSend消息</span><br><span class="line">    ToSend notmsg = new ToSend(ToSend.mType.notification,</span><br><span class="line">            current.getId(),</span><br><span class="line">            current.getZxid(),</span><br><span class="line">            logicalclock,</span><br><span class="line">            self.getPeerState(),</span><br><span class="line">            response.sid,</span><br><span class="line">            current.getPeerEpoch());</span><br><span class="line">    // 放入sendqueue队列，等待发送</span><br><span class="line">    sendqueue.offer(notmsg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　若包含该服务器，则根据消息（Message）解析出投票服务器的投票信息并将其封装为Notification，然后判断当前服务器是否为LOOKING，若为LOOKING，则直接将Notification放入FastLeaderElection的recvqueue（区别于recvQueue）中。然后判断投票服务器是否为LOOKING状态，并且其选举周期小于当前服务器的逻辑时钟，则将本（当前）服务器的内部投票发送给该服务器，否则，直接忽略掉该投票。其流程如下　　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">if(self.getPeerState() == QuorumPeer.ServerState.LOOKING)&#123; // 本服务器为LOOKING状态</span><br><span class="line">    // 将消息放入recvqueue中</span><br><span class="line">    recvqueue.offer(n);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Send a notification back if the peer that sent this</span><br><span class="line">     * message is also looking and its logical clock is</span><br><span class="line">     * lagging behind.</span><br><span class="line">     */</span><br><span class="line">    if((ackstate == QuorumPeer.ServerState.LOOKING) // 推选者服务器为LOOKING状态</span><br><span class="line">            &amp;&amp; (n.electionEpoch &lt; logicalclock))&#123; // 选举周期小于逻辑时钟</span><br><span class="line">        // 创建新的投票</span><br><span class="line">        Vote v = getVote();</span><br><span class="line">        // 构造新的发送消息（本服务器自己的投票）</span><br><span class="line">        ToSend notmsg = new ToSend(ToSend.mType.notification,</span><br><span class="line">                v.getId(),</span><br><span class="line">                v.getZxid(),</span><br><span class="line">                logicalclock,</span><br><span class="line">                self.getPeerState(),</span><br><span class="line">                response.sid,</span><br><span class="line">                v.getPeerEpoch());</span><br><span class="line">        // 将发送消息放置于队列，等待发送</span><br><span class="line">        sendqueue.offer(notmsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　若本服务器的状态不为LOOKING，则会根据投票服务器中解析的version信息来构造ToSend消息，放入sendqueue，等待发送，起流程如下　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> else &#123; // 本服务器状态不为LOOKING</span><br><span class="line">    /*</span><br><span class="line">     * If this server is not looking, but the one that sent the ack</span><br><span class="line">     * is looking, then send back what it believes to be the leader.</span><br><span class="line">     */</span><br><span class="line">    // 获取当前投票</span><br><span class="line">    Vote current = self.getCurrentVote(); </span><br><span class="line">    if(ackstate == QuorumPeer.ServerState.LOOKING)&#123; // 为LOOKING状态</span><br><span class="line">        if(LOG.isDebugEnabled())&#123;</span><br><span class="line">            LOG.debug(&quot;Sending new notification. My id =  &quot; +</span><br><span class="line">                    self.getId() + &quot; recipient=&quot; +</span><br><span class="line">                    response.sid + &quot; zxid=0x&quot; +</span><br><span class="line">                    Long.toHexString(current.getZxid()) +</span><br><span class="line">                    &quot; leader=&quot; + current.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ToSend notmsg;</span><br><span class="line">        if(n.version &gt; 0x0) &#123; // 版本号大于0</span><br><span class="line">            // 构造ToSend消息</span><br><span class="line">            notmsg = new ToSend(</span><br><span class="line">                    ToSend.mType.notification,</span><br><span class="line">                    current.getId(),</span><br><span class="line">                    current.getZxid(),</span><br><span class="line">                    current.getElectionEpoch(),</span><br><span class="line">                    self.getPeerState(),</span><br><span class="line">                    response.sid,</span><br><span class="line">                    current.getPeerEpoch());</span><br><span class="line">            </span><br><span class="line">        &#125; else &#123; // 版本号不大于0</span><br><span class="line">            // 构造ToSend消息</span><br><span class="line">            Vote bcVote = self.getBCVote();</span><br><span class="line">            notmsg = new ToSend(</span><br><span class="line">                    ToSend.mType.notification,</span><br><span class="line">                    bcVote.getId(),</span><br><span class="line">                    bcVote.getZxid(),</span><br><span class="line">                    bcVote.getElectionEpoch(),</span><br><span class="line">                    self.getPeerState(),</span><br><span class="line">                    response.sid,</span><br><span class="line">                    bcVote.getPeerEpoch());</span><br><span class="line">        &#125;</span><br><span class="line">        // 将发送消息放置于队列，等待发送</span><br><span class="line">        sendqueue.offer(notmsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　2. WorkerSender</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="img"> WorkerSender</p>
<p>　　说明：WorkerSender也实现了Runnable接口，为选票发送器，其会不断地从sendqueue中获取待发送的选票，并将其传递到底层QuorumCnxManager中，其过程是将FastLeaderElection的ToSend转化为QuorumCnxManager的Message。</p>
<p>　　3.2 类的属性　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected class Messenger &#123;</span><br><span class="line">    // 选票发送器</span><br><span class="line">    WorkerSender ws;</span><br><span class="line">    // 选票接收器</span><br><span class="line">    WorkerReceiver wr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：Messenger中维护了一个WorkerSender和WorkerReceiver，分别表示选票发送器和选票接收器。</p>
<p>　　3.3 类的构造函数　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Messenger(QuorumCnxManager manager) &#123;</span><br><span class="line">    // 创建WorkerSender</span><br><span class="line">    this.ws = new WorkerSender(manager);</span><br><span class="line">    // 新创建线程</span><br><span class="line">    Thread t = new Thread(this.ws,</span><br><span class="line">            &quot;WorkerSender[myid=&quot; + self.getId() + &quot;]&quot;);</span><br><span class="line">    // 设置为守护线程</span><br><span class="line">    t.setDaemon(true);</span><br><span class="line">    // 启动</span><br><span class="line">    t.start();</span><br><span class="line"></span><br><span class="line">    // 创建WorkerReceiver</span><br><span class="line">    this.wr = new WorkerReceiver(manager);</span><br><span class="line">    // 创建线程</span><br><span class="line">    t = new Thread(this.wr,</span><br><span class="line">            &quot;WorkerReceiver[myid=&quot; + self.getId() + &quot;]&quot;);</span><br><span class="line">    // 设置为守护线程</span><br><span class="line">    t.setDaemon(true);</span><br><span class="line">    // 启动</span><br><span class="line">    t.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：会启动WorkerSender和WorkerReceiver，并设置为守护线程。</p>
<p>　　2.3 类的属性　</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public class FastLeaderElection implements Election &#123;</span><br><span class="line">    // 日志</span><br><span class="line">    private static final Logger LOG = LoggerFactory.getLogger(FastLeaderElection.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Determine how much time a process has to wait</span><br><span class="line">     * once it believes that it has reached the end of</span><br><span class="line">     * leader election.</span><br><span class="line">     */</span><br><span class="line">    // 完成Leader选举之后需要等待时长</span><br><span class="line">    final static int finalizeWait = 200;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Upper bound on the amount of time between two consecutive</span><br><span class="line">     * notification checks. This impacts the amount of time to get</span><br><span class="line">     * the system up again after long partitions. Currently 60 seconds.</span><br><span class="line">     */</span><br><span class="line">    // 两个连续通知检查之间的最大时长</span><br><span class="line">    final static int maxNotificationInterval = 60000;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Connection manager. Fast leader election uses TCP for</span><br><span class="line">     * communication between peers, and QuorumCnxManager manages</span><br><span class="line">     * such connections.</span><br><span class="line">     */</span><br><span class="line">    // 管理服务器之间的连接</span><br><span class="line">    QuorumCnxManager manager;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    // 选票发送队列，用于保存待发送的选票</span><br><span class="line">    LinkedBlockingQueue&lt;ToSend&gt; sendqueue;</span><br><span class="line">    </span><br><span class="line">    // 选票接收队列，用于保存接收到的外部投票</span><br><span class="line">    LinkedBlockingQueue&lt;Notification&gt; recvqueue;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    // 投票者</span><br><span class="line">    QuorumPeer self;</span><br><span class="line">    Messenger messenger;</span><br><span class="line">    // 逻辑时钟</span><br><span class="line">    volatile long logicalclock; /* Election instance */</span><br><span class="line">    // 推选的leader的id</span><br><span class="line">    long proposedLeader;</span><br><span class="line">    // 推选的leader的zxid</span><br><span class="line">    long proposedZxid;</span><br><span class="line">    // 推选的leader的选举周期</span><br><span class="line">    long proposedEpoch;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    // 是否停止选举</span><br><span class="line">    volatile boolean stop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：其维护了服务器之间的连接（用于发送消息）、发送消息队列、接收消息队列、推选者的一些信息（zxid、id）、是否停止选举流程标识等。</p>
<p>　　2.4 类的构造函数　　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public FastLeaderElection(QuorumPeer self, QuorumCnxManager manager)&#123;</span><br><span class="line">    // 字段赋值</span><br><span class="line">    this.stop = false;</span><br><span class="line">    this.manager = manager;</span><br><span class="line">    // 初始化其他信息</span><br><span class="line">    starter(self, manager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：构造函数中初始化了stop字段和manager字段，并且调用了starter函数，其源码如下　　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void starter(QuorumPeer self, QuorumCnxManager manager) &#123;</span><br><span class="line">    // 赋值，对Leader和投票者的ID进行初始化操作</span><br><span class="line">    this.self = self;</span><br><span class="line">    proposedLeader = -1;</span><br><span class="line">    proposedZxid = -1;</span><br><span class="line">    </span><br><span class="line">    // 初始化发送队列</span><br><span class="line">    sendqueue = new LinkedBlockingQueue&lt;ToSend&gt;();</span><br><span class="line">    // 初始化接收队列</span><br><span class="line">    recvqueue = new LinkedBlockingQueue&lt;Notification&gt;();</span><br><span class="line">    // 创建Messenger，会启动接收器和发送器线程</span><br><span class="line">    this.messenger = new Messenger(manager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：其完成在构造函数中未完成的部分，如会初始化FastLeaderElection的sendqueue和recvqueue，并且启动接收器和发送器线程。</p>
<p>　　2.5 核心函数分析</p>
<p>　　1. sendNotifications函数　　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private void sendNotifications() &#123;</span><br><span class="line">    for (QuorumServer server : self.getVotingView().values()) &#123; // 遍历投票参与者集合</span><br><span class="line">        long sid = server.id;</span><br><span class="line">        </span><br><span class="line">        // 构造发送消息</span><br><span class="line">        ToSend notmsg = new ToSend(ToSend.mType.notification,</span><br><span class="line">                proposedLeader,</span><br><span class="line">                proposedZxid,</span><br><span class="line">                logicalclock,</span><br><span class="line">                QuorumPeer.ServerState.LOOKING,</span><br><span class="line">                sid,</span><br><span class="line">                proposedEpoch);</span><br><span class="line">        if(LOG.isDebugEnabled())&#123;</span><br><span class="line">            LOG.debug(&quot;Sending Notification: &quot; + proposedLeader + &quot; (n.leader), 0x&quot;  +</span><br><span class="line">                  Long.toHexString(proposedZxid) + &quot; (n.zxid), 0x&quot; + Long.toHexString(logicalclock)  +</span><br><span class="line">                  &quot; (n.round), &quot; + sid + &quot; (recipient), &quot; + self.getId() +</span><br><span class="line">                  &quot; (myid), 0x&quot; + Long.toHexString(proposedEpoch) + &quot; (n.peerEpoch)&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        // 将发送消息放置于队列</span><br><span class="line">        sendqueue.offer(notmsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：其会遍历所有的参与者投票集合，然后将自己的选票信息发送至上述所有的投票者集合，其并非同步发送，而是将ToSend消息放置于sendqueue中，之后由WorkerSender进行发送。</p>
<p>　　2. totalOrderPredicate函数　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected boolean totalOrderPredicate(long newId, long newZxid, long newEpoch, long curId, long curZxid, long curEpoch) &#123;</span><br><span class="line">    LOG.debug(&quot;id: &quot; + newId + &quot;, proposed id: &quot; + curId + &quot;, zxid: 0x&quot; +</span><br><span class="line">            Long.toHexString(newZxid) + &quot;, proposed zxid: 0x&quot; + Long.toHexString(curZxid));</span><br><span class="line">    if(self.getQuorumVerifier().getWeight(newId) == 0)&#123; // 使用计票器判断当前服务器的权重是否为0</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /*</span><br><span class="line">     * We return true if one of the following three cases hold:</span><br><span class="line">     * 1- New epoch is higher</span><br><span class="line">     * 2- New epoch is the same as current epoch, but new zxid is higher</span><br><span class="line">     * 3- New epoch is the same as current epoch, new zxid is the same</span><br><span class="line">     *  as current zxid, but server id is higher.</span><br><span class="line">     */</span><br><span class="line">    // 1. 判断消息里的epoch是不是比当前的大，如果大则消息中id对应的服务器就是leader</span><br><span class="line">    // 2. 如果epoch相等则判断zxid，如果消息里的zxid大，则消息中id对应的服务器就是leader</span><br><span class="line">    // 3. 如果前面两个都相等那就比较服务器id，如果大，则其就是leader</span><br><span class="line">    return ((newEpoch &gt; curEpoch) ||</span><br><span class="line">            ((newEpoch == curEpoch) &amp;&amp;</span><br><span class="line">            ((newZxid &gt; curZxid) || ((newZxid == curZxid) &amp;&amp; (newId &gt; curId)))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：该函数将接收的投票与自身投票进行PK，查看是否消息中包含的服务器id是否更优，其按照epoch、zxid、id的优先级进行PK。</p>
<p>　　3. termPredicate函数　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected boolean termPredicate(</span><br><span class="line">        HashMap&lt;Long, Vote&gt; votes,</span><br><span class="line">        Vote vote) &#123;</span><br><span class="line"></span><br><span class="line">    HashSet&lt;Long&gt; set = new HashSet&lt;Long&gt;();</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * First make the views consistent. Sometimes peers will have</span><br><span class="line">     * different zxids for a server depending on timing.</span><br><span class="line">     */</span><br><span class="line">    for (Map.Entry&lt;Long,Vote&gt; entry : votes.entrySet()) &#123; // 遍历已经接收的投票集合</span><br><span class="line">        if (vote.equals(entry.getValue()))&#123; // 将等于当前投票的项放入set</span><br><span class="line">            set.add(entry.getKey());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //统计set，查看投某个id的票数是否超过一半</span><br><span class="line">    return self.getQuorumVerifier().containsQuorum(set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：该函数用于判断Leader选举是否结束，即是否有一半以上的服务器选出了相同的Leader，其过程是将收到的选票与当前选票进行对比，选票相同的放入同一个集合，之后判断选票相同的集合是否超过了半数。</p>
<p>　　4. checkLeader函数　　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">protected boolean checkLeader(</span><br><span class="line">        HashMap&lt;Long, Vote&gt; votes,</span><br><span class="line">        long leader,</span><br><span class="line">        long electionEpoch)&#123;</span><br><span class="line">    </span><br><span class="line">    boolean predicate = true;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * If everyone else thinks I&apos;m the leader, I must be the leader.</span><br><span class="line">     * The other two checks are just for the case in which I&apos;m not the</span><br><span class="line">     * leader. If I&apos;m not the leader and I haven&apos;t received a message</span><br><span class="line">     * from leader stating that it is leading, then predicate is false.</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    if(leader != self.getId())&#123; // 自己不为leader</span><br><span class="line">        if(votes.get(leader) == null) predicate = false; // 还未选出leader</span><br><span class="line">        else if(votes.get(leader).getState() != ServerState.LEADING) predicate = false; // 选出的leader还未给出ack信号，其他服务器还不知道leader</span><br><span class="line">    &#125; else if(logicalclock != electionEpoch) &#123; // 逻辑时钟不等于选举周期</span><br><span class="line">        predicate = false;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    return predicate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：该函数检查是否已经完成了Leader的选举，此时Leader的状态应该是LEADING状态。</p>
<p>　　5. lookForLeader函数　　</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line">public Vote lookForLeader() throws InterruptedException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        self.jmxLeaderElectionBean = new LeaderElectionBean();</span><br><span class="line">        MBeanRegistry.getInstance().register(</span><br><span class="line">                self.jmxLeaderElectionBean, self.jmxLocalPeerBean);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        LOG.warn(&quot;Failed to register with JMX&quot;, e);</span><br><span class="line">        self.jmxLeaderElectionBean = null;</span><br><span class="line">    &#125;</span><br><span class="line">    if (self.start_fle == 0) &#123;</span><br><span class="line">       self.start_fle = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        HashMap&lt;Long, Vote&gt; recvset = new HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Long, Vote&gt; outofelection = new HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        int notTimeout = finalizeWait;</span><br><span class="line"></span><br><span class="line">        synchronized(this)&#123;</span><br><span class="line">            // 更新逻辑时钟，每进行一轮选举，都需要更新逻辑时钟</span><br><span class="line">            logicalclock++;</span><br><span class="line">            // 更新选票</span><br><span class="line">            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG.info(&quot;New election. My id =  &quot; + self.getId() +</span><br><span class="line">                &quot;, proposed zxid=0x&quot; + Long.toHexString(proposedZxid));</span><br><span class="line">        // 想其他服务器发送自己的选票</span><br><span class="line">        sendNotifications();</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * Loop in which we exchange notifications until we find a leader</span><br><span class="line">         */</span><br><span class="line"></span><br><span class="line">        while ((self.getPeerState() == ServerState.LOOKING) &amp;&amp;</span><br><span class="line">                (!stop))&#123; // 本服务器状态为LOOKING并且还未选出leader</span><br><span class="line">            /*</span><br><span class="line">             * Remove next notification from queue, times out after 2 times</span><br><span class="line">             * the termination time</span><br><span class="line">             */</span><br><span class="line">            // 从recvqueue接收队列中取出投票</span><br><span class="line">            Notification n = recvqueue.poll(notTimeout,</span><br><span class="line">                    TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">            /*</span><br><span class="line">             * Sends more notifications if haven&apos;t received enough.</span><br><span class="line">             * Otherwise processes new notification.</span><br><span class="line">             */</span><br><span class="line">            if(n == null)&#123; // 如果没有收到足够多的选票，则发送选票</span><br><span class="line">                if(manager.haveDelivered())&#123; // manager已经发送了所有选票消息</span><br><span class="line">                    // 向所有其他服务器发送消息</span><br><span class="line">                    sendNotifications();</span><br><span class="line">                &#125; else &#123; // 还未发送所有消息</span><br><span class="line">                    // 连接其他每个服务器</span><br><span class="line">                    manager.connectAll();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                /*</span><br><span class="line">                 * Exponential backoff</span><br><span class="line">                 */</span><br><span class="line">                int tmpTimeOut = notTimeout*2;</span><br><span class="line">                notTimeout = (tmpTimeOut &lt; maxNotificationInterval?</span><br><span class="line">                        tmpTimeOut : maxNotificationInterval);</span><br><span class="line">                LOG.info(&quot;Notification time out: &quot; + notTimeout);</span><br><span class="line">            &#125;</span><br><span class="line">            else if(self.getVotingView().containsKey(n.sid)) &#123; // 投票者集合中包含接收到消息中的服务器id</span><br><span class="line">                /*</span><br><span class="line">                 * Only proceed if the vote comes from a replica in the</span><br><span class="line">                 * voting view.</span><br><span class="line">                 */</span><br><span class="line">                switch (n.state) &#123; // 确定接收消息中的服务器状态</span><br><span class="line">                case LOOKING: </span><br><span class="line">                    // If notification &gt; current, replace and send messages out</span><br><span class="line">                    if (n.electionEpoch &gt; logicalclock) &#123; // 其选举周期大于逻辑时钟</span><br><span class="line">                        // 重新赋值逻辑时钟</span><br><span class="line">                        logicalclock = n.electionEpoch;</span><br><span class="line">                        recvset.clear();</span><br><span class="line">                        if(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123; // 选出较优的服务器</span><br><span class="line">                            // 更新选票</span><br><span class="line">                            updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        &#125; else &#123; // 无法选出较优的服务器</span><br><span class="line">                            // 更新选票</span><br><span class="line">                            updateProposal(getInitId(),</span><br><span class="line">                                    getInitLastLoggedZxid(),</span><br><span class="line">                                    getPeerEpoch());</span><br><span class="line">                        &#125;</span><br><span class="line">                        // 发送消息</span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125; else if (n.electionEpoch &lt; logicalclock) &#123; // 选举周期小于逻辑时钟，不做处理</span><br><span class="line">                        if(LOG.isDebugEnabled())&#123;</span><br><span class="line">                            LOG.debug(&quot;Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x&quot;</span><br><span class="line">                                    + Long.toHexString(n.electionEpoch)</span><br><span class="line">                                    + &quot;, logicalclock=0x&quot; + Long.toHexString(logicalclock));</span><br><span class="line">                        &#125;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125; else if (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                            proposedLeader, proposedZxid, proposedEpoch)) &#123; // 等于，并且能选出较优的服务器</span><br><span class="line">                        // 更新选票</span><br><span class="line">                        updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        // 发送消息</span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if(LOG.isDebugEnabled())&#123;</span><br><span class="line">                        LOG.debug(&quot;Adding vote: from=&quot; + n.sid +</span><br><span class="line">                                &quot;, proposed leader=&quot; + n.leader +</span><br><span class="line">                                &quot;, proposed zxid=0x&quot; + Long.toHexString(n.zxid) +</span><br><span class="line">                                &quot;, proposed election epoch=0x&quot; + Long.toHexString(n.electionEpoch));</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    // recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票</span><br><span class="line">                    recvset.put(n.sid, new Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line"></span><br><span class="line">                    if (termPredicate(recvset,</span><br><span class="line">                            new Vote(proposedLeader, proposedZxid,</span><br><span class="line">                                    logicalclock, proposedEpoch))) &#123; // 若能选出leader</span><br><span class="line"></span><br><span class="line">                        // Verify if there is any change in the proposed leader</span><br><span class="line">                        while((n = recvqueue.poll(finalizeWait,</span><br><span class="line">                                TimeUnit.MILLISECONDS)) != null)&#123; // 遍历已经接收的投票集合</span><br><span class="line">                            if(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                    proposedLeader, proposedZxid, proposedEpoch))&#123; // 能够选出较优的服务器</span><br><span class="line">                                recvqueue.put(n);</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        /*</span><br><span class="line">                         * This predicate is true once we don&apos;t read any new</span><br><span class="line">                         * relevant message from the reception queue</span><br><span class="line">                         */</span><br><span class="line">                        if (n == null) &#123;</span><br><span class="line">                            self.setPeerState((proposedLeader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line"></span><br><span class="line">                            Vote endVote = new Vote(proposedLeader,</span><br><span class="line">                                                    proposedZxid,</span><br><span class="line">                                                    logicalclock,</span><br><span class="line">                                                    proposedEpoch);</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            return endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case OBSERVING:</span><br><span class="line">                    LOG.debug(&quot;Notification from observer: &quot; + n.sid);</span><br><span class="line">                    break;</span><br><span class="line">                case FOLLOWING:</span><br><span class="line">                case LEADING: // 处于LEADING状态</span><br><span class="line">                    /*</span><br><span class="line">                     * Consider all notifications from the same epoch</span><br><span class="line">                     * together.</span><br><span class="line">                     */</span><br><span class="line">                    if(n.electionEpoch == logicalclock)&#123; // 与逻辑时钟相等</span><br><span class="line">                        // 将该服务器和选票信息放入recvset中</span><br><span class="line">                        recvset.put(n.sid, new Vote(n.leader,</span><br><span class="line">                                                      n.zxid,</span><br><span class="line">                                                      n.electionEpoch,</span><br><span class="line">                                                      n.peerEpoch));</span><br><span class="line">                       </span><br><span class="line">                        if(ooePredicate(recvset, outofelection, n)) &#123; // 判断是否完成了leader选举</span><br><span class="line">                            // 设置本服务器的状态</span><br><span class="line">                            self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line">                            // 创建投票信息</span><br><span class="line">                            Vote endVote = new Vote(n.leader, </span><br><span class="line">                                    n.zxid, </span><br><span class="line">                                    n.electionEpoch, </span><br><span class="line">                                    n.peerEpoch);</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            return endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    /*</span><br><span class="line">                     * Before joining an established ensemble, verify</span><br><span class="line">                     * a majority is following the same leader.</span><br><span class="line">                     */</span><br><span class="line">                    outofelection.put(n.sid, new Vote(n.version,</span><br><span class="line">                                                        n.leader,</span><br><span class="line">                                                        n.zxid,</span><br><span class="line">                                                        n.electionEpoch,</span><br><span class="line">                                                        n.peerEpoch,</span><br><span class="line">                                                        n.state));</span><br><span class="line">       </span><br><span class="line">                    if(ooePredicate(outofelection, outofelection, n)) &#123;</span><br><span class="line">                        synchronized(this)&#123;</span><br><span class="line">                            logicalclock = n.electionEpoch;</span><br><span class="line">                            self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line">                        &#125;</span><br><span class="line">                        Vote endVote = new Vote(n.leader,</span><br><span class="line">                                                n.zxid,</span><br><span class="line">                                                n.electionEpoch,</span><br><span class="line">                                                n.peerEpoch);</span><br><span class="line">                        leaveInstance(endVote);</span><br><span class="line">                        return endVote;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    LOG.warn(&quot;Notification state unrecognized: &#123;&#125; (n.state), &#123;&#125; (n.sid)&quot;,</span><br><span class="line">                            n.state, n.sid);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                LOG.warn(&quot;Ignoring notification from non-cluster member &quot; + n.sid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if(self.jmxLeaderElectionBean != null)&#123;</span><br><span class="line">                MBeanRegistry.getInstance().unregister(</span><br><span class="line">                        self.jmxLeaderElectionBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            LOG.warn(&quot;Failed to unregister with JMX&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        self.jmxLeaderElectionBean = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　说明：该函数用于开始新一轮的Leader选举，其首先会将逻辑时钟自增，然后更新本服务器的选票信息（初始化选票），之后将选票信息放入sendqueue等待发送给其他服务器，其流程如下　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">synchronized(this)&#123;</span><br><span class="line">    // 更新逻辑时钟，每进行一轮新的leader选举，都需要更新逻辑时钟</span><br><span class="line">    logicalclock++;</span><br><span class="line">    // 更新选票（初始化选票）</span><br><span class="line">    updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LOG.info(&quot;New election. My id =  &quot; + self.getId() +</span><br><span class="line">        &quot;, proposed zxid=0x&quot; + Long.toHexString(proposedZxid));</span><br><span class="line">// 向其他服务器发送自己的选票（已更新的选票）</span><br><span class="line">sendNotifications();</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　之后每台服务器会不断地从recvqueue队列中获取外部选票。如果服务器发现无法获取到任何外部投票，就立即确认自己是否和集群中其他服务器保持着有效的连接，如果没有连接，则马上建立连接，如果已经建立了连接，则再次发送自己当前的内部投票，其流程如下　　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 从recvqueue接收队列中取出投票</span><br><span class="line">Notification n = recvqueue.poll(notTimeout,</span><br><span class="line">        TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Sends more notifications if haven&apos;t received enough.</span><br><span class="line"> * Otherwise processes new notification.</span><br><span class="line"> */</span><br><span class="line">if(n == null)&#123; // 无法获取选票</span><br><span class="line">    if(manager.haveDelivered())&#123; // manager已经发送了所有选票消息（表示有连接）</span><br><span class="line">        // 向所有其他服务器发送消息</span><br><span class="line">        sendNotifications();</span><br><span class="line">    &#125; else &#123; // 还未发送所有消息（表示无连接）</span><br><span class="line">        // 连接其他每个服务器</span><br><span class="line">        manager.connectAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Exponential backoff</span><br><span class="line">     */</span><br><span class="line">    int tmpTimeOut = notTimeout*2;</span><br><span class="line">    notTimeout = (tmpTimeOut &lt; maxNotificationInterval?</span><br><span class="line">            tmpTimeOut : maxNotificationInterval);</span><br><span class="line">    LOG.info(&quot;Notification time out: &quot; + notTimeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　在发送完初始化选票之后，接着开始处理外部投票。在处理外部投票时，会根据选举轮次来进行不同的处理。　　</p>
<p>　　　　<strong>· 外部投票的选举轮次大于内部投票</strong>。若服务器自身的选举轮次落后于该外部投票对应服务器的选举轮次，那么就会立即更新自己的选举轮次(logicalclock)，并且清空所有已经收到的投票，然后使用初始化的投票来进行PK以确定是否变更内部投票。最终再将内部投票发送出去。</p>
<p>　　　　<strong>· 外部投票的选举轮次小于内部投**</strong>票**。若服务器接收的外选票的选举轮次落后于自身的选举轮次，那么Zookeeper就会直接忽略该外部投票，不做任何处理。</p>
<p>　　　　<strong>· 外部投票的选举轮次等于内部投票</strong>。此时可以开始进行选票PK，如果消息中的选票更优，则需要更新本服务器内部选票，再发送给其他服务器。</p>
<p>　　之后再对选票进行归档操作，无论是否变更了投票，都会将刚刚收到的那份外部投票放入选票集合recvset中进行归档，其中recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票，然后开始统计投票，统计投票是为了统计集群中是否已经有过半的服务器认可了当前的内部投票，如果确定已经有过半服务器认可了该投票，然后再进行最后一次确认，判断是否又有更优的选票产生，若无，则终止投票，然后最终的选票，其流程如下</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">if (n.electionEpoch &gt; logicalclock) &#123; // 其选举周期大于逻辑时钟</span><br><span class="line">    // 重新赋值逻辑时钟</span><br><span class="line">    logicalclock = n.electionEpoch;</span><br><span class="line">    // 清空所有接收到的所有选票</span><br><span class="line">    recvset.clear();</span><br><span class="line">    if(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">            getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123; // 进行PK，选出较优的服务器</span><br><span class="line">        // 更新选票</span><br><span class="line">        updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">    &#125; else &#123; // 无法选出较优的服务器</span><br><span class="line">        // 更新选票</span><br><span class="line">        updateProposal(getInitId(),</span><br><span class="line">                getInitLastLoggedZxid(),</span><br><span class="line">                getPeerEpoch());</span><br><span class="line">    &#125;</span><br><span class="line">    // 发送本服务器的内部选票消息</span><br><span class="line">    sendNotifications();</span><br><span class="line">&#125; else if (n.electionEpoch &lt; logicalclock) &#123; // 选举周期小于逻辑时钟，不做处理，直接忽略</span><br><span class="line">    if(LOG.isDebugEnabled())&#123;</span><br><span class="line">        LOG.debug(&quot;Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x&quot;</span><br><span class="line">                + Long.toHexString(n.electionEpoch)</span><br><span class="line">                + &quot;, logicalclock=0x&quot; + Long.toHexString(logicalclock));</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125; else if (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">        proposedLeader, proposedZxid, proposedEpoch)) &#123; // PK，选出较优的服务器</span><br><span class="line">    // 更新选票</span><br><span class="line">    updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">    // 发送消息</span><br><span class="line">    sendNotifications();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(LOG.isDebugEnabled())&#123;</span><br><span class="line">    LOG.debug(&quot;Adding vote: from=&quot; + n.sid +</span><br><span class="line">            &quot;, proposed leader=&quot; + n.leader +</span><br><span class="line">            &quot;, proposed zxid=0x&quot; + Long.toHexString(n.zxid) +</span><br><span class="line">            &quot;, proposed election epoch=0x&quot; + Long.toHexString(n.electionEpoch));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票</span><br><span class="line">recvset.put(n.sid, new Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line"></span><br><span class="line">if (termPredicate(recvset,</span><br><span class="line">        new Vote(proposedLeader, proposedZxid,</span><br><span class="line">                logicalclock, proposedEpoch))) &#123; // 若能选出leader</span><br><span class="line"></span><br><span class="line">    // Verify if there is any change in the proposed leader</span><br><span class="line">    while((n = recvqueue.poll(finalizeWait,</span><br><span class="line">            TimeUnit.MILLISECONDS)) != null)&#123; // 遍历已经接收的投票集合</span><br><span class="line">        if(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                proposedLeader, proposedZxid, proposedEpoch))&#123; // 选票有变更，比之前提议的Leader有更好的选票加入</span><br><span class="line">            // 将更优的选票放在recvset中</span><br><span class="line">            recvqueue.put(n);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * This predicate is true once we don&apos;t read any new</span><br><span class="line">     * relevant message from the reception queue</span><br><span class="line">     */</span><br><span class="line">    if (n == null) &#123; // 表示之前提议的Leader已经是最优的</span><br><span class="line">        // 设置服务器状态</span><br><span class="line">        self.setPeerState((proposedLeader == self.getId()) ?</span><br><span class="line">                ServerState.LEADING: learningState());</span><br><span class="line">        // 最终的选票</span><br><span class="line">        Vote endVote = new Vote(proposedLeader,</span><br><span class="line">                                proposedZxid,</span><br><span class="line">                                logicalclock,</span><br><span class="line">                                proposedEpoch);</span><br><span class="line">        // 清空recvqueue队列的选票</span><br><span class="line">        leaveInstance(endVote);</span><br><span class="line">        // 返回选票</span><br><span class="line">        return endVote;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　若选票中的服务器状态为FOLLOWING或者LEADING时，其大致步骤会判断选举周期是否等于逻辑时钟，归档选票，是否已经完成了Leader选举，设置服务器状态，修改逻辑时钟等于选举周期，返回最终选票，其流程如下　</p>
<p><a href="javascript:void(0);" target="_blank" rel="noopener"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">if(n.electionEpoch == logicalclock)&#123; // 与逻辑时钟相等</span><br><span class="line">    // 将该服务器和选票信息放入recvset中</span><br><span class="line">    recvset.put(n.sid, new Vote(n.leader,</span><br><span class="line">                                  n.zxid,</span><br><span class="line">                                  n.electionEpoch,</span><br><span class="line">                                  n.peerEpoch));</span><br><span class="line">   </span><br><span class="line">    if(ooePredicate(recvset, outofelection, n)) &#123; // 已经完成了leader选举</span><br><span class="line">        // 设置本服务器的状态</span><br><span class="line">        self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                ServerState.LEADING: learningState());</span><br><span class="line">        // 最终的选票</span><br><span class="line">        Vote endVote = new Vote(n.leader, </span><br><span class="line">                n.zxid, </span><br><span class="line">                n.electionEpoch, </span><br><span class="line">                n.peerEpoch);</span><br><span class="line">        // 清空recvqueue队列的选票</span><br><span class="line">        leaveInstance(endVote);</span><br><span class="line">        return endVote;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Before joining an established ensemble, verify</span><br><span class="line"> * a majority is following the same leader.</span><br><span class="line"> */</span><br><span class="line">outofelection.put(n.sid, new Vote(n.version,</span><br><span class="line">                                    n.leader,</span><br><span class="line">                                    n.zxid,</span><br><span class="line">                                    n.electionEpoch,</span><br><span class="line">                                    n.peerEpoch,</span><br><span class="line">                                    n.state));</span><br><span class="line">           </span><br><span class="line">if(ooePredicate(outofelection, outofelection, n)) &#123; // 已经完成了leader选举</span><br><span class="line">    synchronized(this)&#123;</span><br><span class="line">        // 设置逻辑时钟</span><br><span class="line">        logicalclock = n.electionEpoch;</span><br><span class="line">        // 设置状态</span><br><span class="line">        self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                ServerState.LEADING: learningState());</span><br><span class="line">    &#125;</span><br><span class="line">    // 最终选票</span><br><span class="line">    Vote endVote = new Vote(n.leader,</span><br><span class="line">                            n.zxid,</span><br><span class="line">                            n.electionEpoch,</span><br><span class="line">                            n.peerEpoch);</span><br><span class="line">    // 清空recvqueue队列的选票</span><br><span class="line">    leaveInstance(endVote);</span><br><span class="line">    // 返回选票</span><br><span class="line">    return endVote;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>Zookeeper目录: <a href="https://www.cnblogs.com/leesf456/p/6239578.html" target="_blank" rel="noopener">https://www.cnblogs.com/leesf456/p/6239578.html</a></li>
<li>Zookeeper源码分析目录: <a href="https://www.cnblogs.com/leesf456/p/6518040.html" target="_blank" rel="noopener">https://www.cnblogs.com/leesf456/p/6518040.html</a></li>
<li></li>
</ul>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/10/gejianxiong-xingwanlilu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/10/gejianxiong-xingwanlilu/" class="post-title-link" itemprop="url">行万里路:葛剑雄旅行</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-10 20:37:14" itemprop="dateCreated datePublished" datetime="2019-08-10T20:37:14+08:00">2019-08-10</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-11 12:32:23" itemprop="dateModified" datetime="2019-08-11T12:32:23+08:00">2019-08-11</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/历史-地理/" itemprop="url" rel="index"><span itemprop="name">历史&地理</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/历史-地理/历史地理/" itemprop="url" rel="index"><span itemprop="name">历史地理</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">4.4k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">4 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>之前在微博上了解过有一个很著名的文化学者: 葛剑雄，那时其title为复旦大学图书馆馆长。后来在杭州图书馆偶尔看到他的一本书叫《行万里路: 葛剑雄旅行》，带回来读了下，没想到他的授业恩师居然是赫赫有名的谭其骧教授(最早通过《中国国家地图集历史地图集》知道他，这部作品是迄今最权威的中国历史政区地图集，谭先生也是中国历史地理学科主要奠基人和开拓者)，所以拜读的兴趣就更浓厚。书中有不少精彩的文章，下面是一些书摘。</p>
<h2 id="开放的城市离不开移民"><a href="#开放的城市离不开移民" class="headerlink" title="开放的城市离不开移民"></a>开放的城市离不开移民</h2><h3 id="移民迁移关乎城市兴衰"><a href="#移民迁移关乎城市兴衰" class="headerlink" title="移民迁移关乎城市兴衰"></a><strong>移民迁移关乎城市兴衰</strong></h3><blockquote>
<p>都市离不开移民，无论是在其形成之初，还是在其发展过程中。一旦移民断绝，甚至出现人口大量外迁，富有该都市特色的文化亦随之而停滞，而衰落，以至最终消亡，古今都市概莫能外。</p>
<p>如西汉长安，是在秦朝咸阳城外的废墟上新建的，故址也只是一个乡，几乎已没有原住民。但在建成之日即迁入大批功臣、贵族、关东六国后裔及豪强，以后又通过迁入陵县(依托皇帝陵墓而设的县)的办法，在长安附近形成了一个城市群，总人口超过一百万。西汉后期，长安一带已是“名都对郭，邑居相承，英俊之域，绂冕所兴，冠盖如云”的繁华都市，形成“五方杂错，风俗不纯”的文化特色。但在公元初新莽政权覆灭引发的战乱中，长安人口损失惨重。东汉建都洛阳后，不仅吸引了大批移民，连长安和关中的精英也纷纷迁往。尽管关中父老仍在梦想有朝一日首都迁回长安，但实际上再未恢复昔日的繁盛。</p>
<p>在北魏孝文帝拓跋宏决定将首都从平城(今山西大同一带)迁往洛阳之时，东汉以来的洛阳早已不复存在。所以在迁都之初只能以金墉城为临时驻地，与西汉迁都长安时的形势相似。但孝文帝实行了最彻底的迁都和汉化政策，所以平城的人口特别是其中的上中层，几乎全部被迁往洛阳。由于此前北魏已在其辖境范围内进行过多次强制性的移民，平城集中了中国北方的上层人士，因而这次新的移民就意味着他们都集中到了洛阳。如在中原战乱中迁往河西走廊的移民后裔，和当地长期形成的文化精英，由西域(泛指今新疆、中亚、印度等地)内迁的僧人、商人、学者等，都先被迁至平城，又被迁于洛阳。此后，洛阳作为北方政权的首都成为中外移民的集中点，也成为多元文化的交汇点。《洛阳伽蓝记》描述了当时的繁盛：“自葱岭已西，至于大秦，百国千城，莫不欢附，商胡贩客，日奔塞下，所谓尽天地之区，已乐中国风土，因而宅者，不可胜数。是以附化之民，万有余家。门巷修整，阊阖填列，青槐荫陌，绿树垂庭，天下难得之货，咸悉在焉。”如此丰富的物质文明也滋养了极其多彩的精神文明，云冈石窟、大批寺庙和辉煌的佛教艺术应运而生。永安二年(529年)，南朝梁国的陈庆之在洛阳短期停留。尽管洛阳的极盛时期已经过去，还是让陈庆之瞠目结舌：“自晋、宋以来，号洛阳为荒土，此中(南方)谓长江以北，尽是夷狄。昨至洛阳，始知衣冠士族并在中原，礼仪富盛，人物殷阜，目所不识，口不能传。所谓‘帝京翼翼，四方之则’，始知登泰山卑培嵝，涉江海者小湘、沅。北人安可不重?”</p>
<p>近代上海是一个典型的移民城市。1843年上海开埠时，整个上海县只有50余万人口，英租界和法租界所在地是上海县城外的乡村，大部分还是农田和坟墓，人口稀少。但到1900年，上海的人口已经突破100万，到1949年更高达500多万。上海开埠时总共才有26位外国人，但以后迅速增加，经常保持着数万人的规模，1943年外国侨民高达15万，1949年上海解放时还有28000多人。上海从一个中等水平的江南县城一跃成为中国和亚洲最大、最发达的都市，移民无疑具有决定性的作用。但自1949年至20世纪70年代末，上海的高素质人口大量迁出，如迁往成为首都的北京，参军参干，支援外地建设，求学，随国民党迁往台湾，迁往港澳和国外，60年代后大规模的大小三线建设和知识青年上山下乡，迁出人口数以百万计。迁入的人口不但数量有限，而且以干部、退伍军人、体力劳动者为主，少数大专毕业生往往学非所用，作用无法充分发挥。再无新的外国侨民迁入，原有侨民大多迁出，未迁者也陆续消失，最后一位外国侨民至80年代初死亡。<strong>由移民带入的内资、外资全部断绝。上海都市文化的长期萧条正是这些因素的必然结果。而同期的香港却因大批高素质内地移民的迁入而获益，更因其特殊地位而成为东西方、海内外文化接触和交流的场所，在相当程度上已与上海主客易位。</strong></p>
</blockquote>
<h2 id="地图上的中国和历史上的中国疆域：谭其骧编纂历史地图集的历程"><a href="#地图上的中国和历史上的中国疆域：谭其骧编纂历史地图集的历程" class="headerlink" title="地图上的中国和历史上的中国疆域：谭其骧编纂历史地图集的历程"></a>地图上的中国和历史上的中国疆域：谭其骧编纂历史地图集的历程</h2><blockquote>
<p>但在重大原则问题上，谭先生对中国疆域的处理是经过深思熟虑，始终坚持的。长期以来，出于政治目的，史学界对今天中国境内的疆域一直强调“自古以来”，似乎中国从夏、商、周三代以来一直是这么大，似乎不找到一点“自古以来”的证据，一个地方归属于中国就失去了合法性。其中最敏感的地方就是台湾，由于谭先生坚持实事求是原则，以史料史实为根据，因此，“文革”期间这成为一条重要的“反革命”罪状，他受到了严厉的批判斗争。在修订过程中，他对台湾的处理方案多次被主管部门否决，《图集》的正式出版因此推迟了好几年，直到中央领导亲自过问并签阅批准，才涉险过关。但是，谭先生坚持认为：</p>
<blockquote>
<p>台湾在明朝以前，既没有设过羁縻府州，也没有设过羁縻卫所，岛上的部落首领没有向大陆王朝进过贡，称过臣，中原王朝更没有在台湾岛上设官置守。过去我们历史学界也受了“左”的影响，把“台湾自古以来是中国的一部分”这句话曲解了。台湾自古以来是中国的一部分，这是一点没有错的，但是你不能把这句话解释为台湾自古以来是中原王朝的一部分，这是完全违反历史事实，明以前历代中原王朝都管不到台湾。有人要把台湾纳入中国从三国时算起，理由是三国时候孙权曾经派军队到过台湾，但历史事实是“军士万人征夷州（即台湾），军行经岁，士众疾疫死者十有八九”，只俘虏了几千人回来，“得不偿失”。我们根据这条史料，就说台湾从三国时候起就是大陆王朝的领土，不是笑话吗？派了一支军队去，俘虏了几千人回来，这块土地就是孙吴的了？这跟清代沙俄殖民者派一支探险队在黑龙江某个地方劫掠一番，就宣称这个地方已归沙俄所有，有什么区别？</p>
<p>有人也感到这样实在说不过去，于是又提出了所谓台澎一体论，这也是绝对讲不通的。我们知道，南宋时澎湖在福建泉州同安县辖境之内，元朝在岛上设立了巡检司，这是大陆王朝在澎湖岛上设立政权之始，这是靠得住的。有些同志主张“台澎一体”论，说是既然在澎湖设立了巡检司，可见元朝已管到了台湾，这怎么说得通？在那么小的澎湖列岛上设了巡检司，就会管到那么大的台湾？宋元明清时，一个县可以设立几个巡检司，这等于现在的公安分局或者是派出所。设在澎湖岛上的巡检司，它就能管辖整个台湾了？有什么证据呢？相反，我们有好多证据证明是管不到的。（台湾）为什么自古以来是中国的？因为历史演变的结果，到了清朝台湾是清帝国疆域的一部分。所以台湾岛上的土著民族——高山族是我们中华民族的一个组成部分，是我们中国的一个少数民族。对台湾我们应该这样理解，在明朝以前，台湾岛是由我们中华民族的成员之一高山族居住着的，他们自己管理自己，中原王朝管不到。到了明朝后期。才有大陆上的汉人跑到台湾岛的西海岸建立了汉人的政权。……一直到1683年（康熙二十二年），清朝平定台湾，台湾才开始同大陆属于一个政权。</p>
</blockquote>
<p>但这种机械的、教条的观念根深蒂固，无处不在，以至在解释任何一个地方“自古以来”就属于中国时，总是采取“实用”甚至“歪曲”的态度，只讲一部分被认为是有利的事实，却完全不提相反的事实，使绝大多数人误以为自古以来都是如此。</p>
<p>例如新疆，只说公元前60年汉宣帝设立西域都护府，却不提及王莽时已经撤销，东汉时“三通三绝”，以后多数年代名存实亡，或者仅是部分恢复；只说唐朝打败突厥，控制整个西域地区，却不提及安史之乱后唐朝再未重返西域；只说蒙古征服西辽，却不提及元朝从未完全统治西域地区。事实上，中原王朝对西域的统治直到乾隆二十四年（1759年）才重新实现。对于清朝来说，西域的确是新纳的疆域，因此，才有“新疆”的命名。谭先生还以云南为例，虽然汉、晋时代是由中原王朝统治，但是，在南朝后期就脱离了中原王朝。隋唐时期，云南是中原王朝的羁縻地区，不是直辖地区。8世纪中叶以后，南诏依附吐蕃反唐，根本就脱离了唐朝。南诏以后成为大理。总之，从6世纪脱离中原王朝，经过了差不多700年，到13世纪才由元朝征服大理，云南地区又被中原王朝统治。</p>
<p>不过，谭先生特别强调：“我们认为18世纪中叶以后，1840年以前的中国范围是我们几千年来历史发展所自然形成的中国，这就是我们历史上的中国。至于现在的中国疆域，已经不是历史上自然形成的那个范围了，而是这一百多年来资本主义列强、帝国主义侵略宰割了我们的部分领土的结果，所以不能代表我们历史上的中国的疆域了”，“为什么说清朝的版图是历史发展自然形成的呢？而不是说清帝国扩张侵略的结果？因为历史事实的确是这样。……清朝以前，我们中原地区跟各个边疆地区关系长期以来就很密切了，不但经济、文化方面很密切，并且在政治上曾经几度和中原地区在一个政权统治之下。”</p>
<p>虽然作为谭先生的学生与助手，深切理解他无法突破政治底线的苦衷。他的上述说法在理论上存在着局限性，在实际上也存在着无法调和的矛盾：一方面，从秦朝最多300多万平方公里的疆域发展到清朝极盛时期1300多万平方公里的疆域，并不能一概称之为“自然形成”。我们不能因为中国最终形成了一个疆域辽阔的国家，就将历史上那些侵略扩张行为视为促进王朝统一、社会进步的必要手段。秦始皇征服岭南，汉武帝用兵闽粤，唐朝灭高句丽、高昌、薛延陀，蒙古人建立元朝，清朝灭明、平定准噶尔，客观上促成国家统一，为中国疆域最终形成奠定了有利条件。但是，这种侵略扩张行为本身，未必就有“自然”的正义性可言；另一方面，在尚未形成现代国际法和国际关系、不同国家民族平等观念之前，世界上能够生存和发展下来的国家，特别是葡、西、荷、英、法、德、日、美、加、澳等近代大国强国，无一不是侵略扩张的产物，中国岂能例外？1840年以前，中国疆域之所以保持稳定，一个重要的有利因素是地理环境的封闭性，以致在工业化以前的外部世界尚缺乏这种突破地理障碍的能力。尽管如此，唐朝军队在中亚受挫于阿拉伯军队，伊斯兰教在突厥语游牧民族的武力支持下侵入新疆地区取代佛教，葡萄牙人长期占据澳门，葡萄牙人、西班牙人、荷兰人相继占据台湾和澎湖，沙俄哥萨克闯进黑龙江流域烧杀抢掠，这也不能不说是国家竞争“自然”的结果。在中俄雅克萨之战并导致《尼布楚条约》签订后，清朝应该了解俄国人的真实意图，而且有足够的时间和能力移民实边，却继续实施对东北的封禁，以致俄国人进入黑龙江以北和乌苏里江以东如入无人之境，至今一些俄国学家还声称俄国人是这片”新土地的开发者”，而非中国领土的掠夺者。但在清朝对东北开禁，鼓励移民，设置府州县，建东三省后，俄国与日本尽管仍然积心积虑要占据东北，却未能得逞。这岂不也是自然的结果吗？</p>
</blockquote>
<h2 id="顺化散记"><a href="#顺化散记" class="headerlink" title="顺化散记"></a>顺化散记</h2><div class="pdf" target="./顺化散记(上)葛剑雄.pdf" height></div>

<div class="pdf" target="./顺化散记(下)葛剑雄.pdf" height></div>
          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/06/bash-shortcuts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/06/bash-shortcuts/" class="post-title-link" itemprop="url">Bash Shell常用快捷键</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-06 10:51:07 / 修改时间：10:56:29" itemprop="dateCreated datePublished" datetime="2019-08-06T10:51:07+08:00">2019-08-06</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/" itemprop="url" rel="index"><span itemprop="name">linux命令</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/Bash-Shell快捷键/" itemprop="url" rel="index"><span itemprop="name">Bash Shell快捷键</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">648</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">1 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="移动光标"><a href="#移动光标" class="headerlink" title="移动光标"></a>移动光标</h2><ul>
<li><code>ctrl+b</code>: 前移一个字符(backward)</li>
<li><code>ctrl+f</code>: 后移一个字符(forward)</li>
<li><code>alt+b</code>: 前移一个单词</li>
<li><code>alt+f</code>: 后移一个单词</li>
<li><code>ctrl+a</code>: 移到行首（a是首字母）</li>
<li><code>ctrl+e</code>: 移到行尾（end）</li>
<li><code>ctrl+xx</code>: 行首到当前光标替换</li>
</ul>
<h2 id="编辑命令"><a href="#编辑命令" class="headerlink" title="编辑命令"></a>编辑命令</h2><ul>
<li><code>alt+.</code>: 粘帖最后一次命令最后的参数（通常用于<code>mkdir long-long-dir</code>后, <code>cd</code>配合着<code>alt+.</code>）</li>
<li><code>alt+d</code>: 删除当前光标到临近右边单词开始(delete)</li>
<li><code>ctrl+w</code>: 删除当前光标到临近左边单词结束(word)</li>
<li><code>ctrl+h</code>: 删除光标前一个字符（相当于backspace）</li>
<li><code>ctrl+d</code>: 删除光标后一个字符（相当于delete）</li>
<li><code>ctrl+u</code>: 删除光标左边所有</li>
<li><code>ctrl+k</code>: 删除光标右边所有</li>
<li><code>ctrl+l</code>: 清屏</li>
<li><code>ctrl+shift+c</code>: 复制（相当于鼠标左键拖拽）</li>
<li><code>ctrl+shift+v</code>: 粘贴（相当于鼠标中键）</li>
</ul>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li><code>ctrl+n</code>: 下一条命令</li>
<li><code>ctrl+p</code>: 上一条命令</li>
<li><code>alt+n</code>: 下一条命令（例如输入<code>ls</code>, 然后按’alt+n’, 就会找到历史记录下的<code>ls</code>命令）</li>
<li><code>alt+p</code>: 上一条命令（跟<code>alt+n</code>相似）</li>
<li><code>shift+PageUp</code>: 向上翻页</li>
<li><code>shift+PageDown</code>: 向下翻页</li>
<li><code>ctrl+r</code>: 进入历史查找命令记录， 输入关键字。 多次按返回下一个匹配项</li>
</ul>
<h2 id="zsh"><a href="#zsh" class="headerlink" title="zsh"></a>zsh</h2><ul>
<li><code>d</code>: 列出以前的打开的命令</li>
<li><code>j</code>: jump到以前某个目录，模糊匹配</li>
</ul>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/05/linux-vim/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/05/linux-vim/" class="post-title-link" itemprop="url">vim命令</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-05 20:42:17" itemprop="dateCreated datePublished" datetime="2019-08-05T20:42:17+08:00">2019-08-05</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-07 10:02:21" itemprop="dateModified" datetime="2019-08-07T10:02:21+08:00">2019-08-07</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/" itemprop="url" rel="index"><span itemprop="name">linux命令</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/vim命令/" itemprop="url" rel="index"><span itemprop="name">vim命令</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">4.8k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">4 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="一般模式"><a href="#一般模式" class="headerlink" title="一般模式"></a>一般模式</h2><h3 id="光标移动"><a href="#光标移动" class="headerlink" title="光标移动"></a>光标移动</h3><table>
<thead>
<tr>
<th>h 或 向左箭头键(←)</th>
<th>光标向左移动一个字符</th>
</tr>
</thead>
<tbody><tr>
<td>j 或 向下箭头键(↓)</td>
<td>光标向下移动一个字符</td>
</tr>
<tr>
<td>k 或 向上箭头键(↑)</td>
<td>光标向上移动一个字符</td>
</tr>
<tr>
<td>l 或 向右箭头键(→)</td>
<td>光标向右移动一个字符</td>
</tr>
<tr>
<td>20j</td>
<td>向下移动20行(以上四个命令可以配合数字使用)，在Vim中，很多命令都可以配合数字使用，比如删除10个字符<code>10x</code></td>
</tr>
<tr>
<td>w</td>
<td>前移一个单词，光标停在下一个单词开头</td>
</tr>
<tr>
<td>2w</td>
<td>重复执行w操作2次</td>
</tr>
<tr>
<td>W</td>
<td>移动下一个单词开头，但忽略一些标点</td>
</tr>
<tr>
<td>e</td>
<td>前移一个单词，光标停在下一个单词末尾</td>
</tr>
<tr>
<td>E</td>
<td>移动到下一个单词末尾，如果词尾有标点，则移动到标点</td>
</tr>
<tr>
<td>b</td>
<td>后移一个单词，光标停在上一个单词开头</td>
</tr>
<tr>
<td>B</td>
<td>移动到上一个单词开头，忽略一些标点</td>
</tr>
<tr>
<td>(</td>
<td>前移1句</td>
</tr>
<tr>
<td>)</td>
<td>后移1句</td>
</tr>
<tr>
<td>3)</td>
<td>光标移动到向下3句</td>
</tr>
<tr>
<td>{</td>
<td>前移1段</td>
</tr>
<tr>
<td>}</td>
<td>后移1段</td>
</tr>
<tr>
<td>f</td>
<td>(find）命令也可以用于移动，<code>fx</code>将找到光标后第一个为x的字符，<code>3fd</code>将找到第三个为d的字符</td>
</tr>
<tr>
<td>F</td>
<td>同f，反向查找</td>
</tr>
<tr>
<td>[Ctrl] + [f]</td>
<td>屏幕『向下』移动一页，相当于 [Page Down]按键 (常用)</td>
</tr>
<tr>
<td>[Ctrl] + [b]</td>
<td>屏幕『向上』移动一页，相当于 [Page Up] 按键 (常用)</td>
</tr>
<tr>
<td>[Ctrl] + [d]</td>
<td>屏幕『向下』移动半页</td>
</tr>
<tr>
<td>[Ctrl] + [u]</td>
<td>屏幕『向上』移动半页</td>
</tr>
<tr>
<td>+</td>
<td>光标移动到非空格符的下一行</td>
</tr>
<tr>
<td>-</td>
<td>光标移动到非空格符的上一行</td>
</tr>
<tr>
<td>n&lt;space&gt;</td>
<td>那个 n 表示『数字』，例如 20 。按下数字后再按空格键，光标会向右移动这一行的 n 个字符。例如 20&lt;space&gt; 则光标会向后面移动 20 个字符距离。</td>
</tr>
<tr>
<td>0 或功能键[Home]</td>
<td>这是数字『 0 』：移动到这一行的最前面字符处 (常用)</td>
</tr>
<tr>
<td>$ 或功能键[End]</td>
<td>移动到这一行的最后面字符处(常用)</td>
</tr>
<tr>
<td>H</td>
<td>光标移动到这个屏幕的最上方那一行的第一个字符</td>
</tr>
<tr>
<td>M</td>
<td>光标移动到这个屏幕的中央那一行的第一个字符</td>
</tr>
<tr>
<td>L</td>
<td>光标移动到这个屏幕的最下方那一行的第一个字符</td>
</tr>
<tr>
<td>G</td>
<td>移动到这个档案的最后一行(常用)</td>
</tr>
<tr>
<td>nG</td>
<td>n 为数字。移动到这个档案的第 n 行。例如 20G 则会移动到这个档案的第 20 行(可配合 :set nu)</td>
</tr>
<tr>
<td>gg</td>
<td>移动到这个档案的第一行，相当于 1G 啊！ (常用)</td>
</tr>
<tr>
<td>n&lt;Enter&gt;</td>
<td>n 为数字。光标向下移动 n 行(常用)</td>
</tr>
</tbody></table>
<h3 id="复制粘贴"><a href="#复制粘贴" class="headerlink" title="复制粘贴"></a>复制粘贴</h3><table>
<thead>
<tr>
<th>x, X</th>
<th>在一行字当中，x 为向后删除一个字符 (相当于 [del] 按键)， X 为向前删除一个字符(相当于 [backspace] 亦即是退格键) (常用)</th>
</tr>
</thead>
<tbody><tr>
<td>nx</td>
<td>n 为数字，连续向后删除 n 个字符。举例来说，我要连续删除 10 个字符， 『10x』。</td>
</tr>
<tr>
<td>dd</td>
<td>删除游标所在的那一整行(常用)</td>
</tr>
<tr>
<td>ndd</td>
<td>n 为数字。删除光标所在的向下 n 行，例如 20dd 则是删除 20 行 (常用)</td>
</tr>
<tr>
<td>d1G</td>
<td>删除光标所在到第一行的所有数据</td>
</tr>
<tr>
<td>dG</td>
<td>删除光标所在到最后一行的所有数据</td>
</tr>
<tr>
<td>d$</td>
<td>删除游标所在处，到该行的最后一个字符</td>
</tr>
<tr>
<td>d0</td>
<td>那个是数字的 0 ，删除游标所在处，到该行的最前面一个字符</td>
</tr>
<tr>
<td>yy</td>
<td>复制游标所在的那一行(常用)</td>
</tr>
<tr>
<td>nyy</td>
<td>n 为数字。复制光标所在的向下 n 行，例如 20yy 则是复制 20 行(常用)</td>
</tr>
<tr>
<td>y1G</td>
<td>复制游标所在行到第一行的所有数据</td>
</tr>
<tr>
<td>yG</td>
<td>复制游标所在行到最后一行的所有数据</td>
</tr>
<tr>
<td>y0</td>
<td>复制光标所在的那个字符到该行行首的所有数据</td>
</tr>
<tr>
<td>y$</td>
<td>复制光标所在的那个字符到该行行尾的所有数据</td>
</tr>
<tr>
<td>p, P</td>
<td>p 为将已复制的数据在光标下一行贴上，P 则为贴在游标上一行！ 举例来说，我目前光标在第 20 行，且已经复制了 10 行数据。则按下 p 后， 那 10 行数据会贴在原本的 20 行之后，亦即由 21 行开始贴。但如果是按下 P 呢？ 那么原本的第 20 行会被推到变成 30 行。 (常用)</td>
</tr>
<tr>
<td>J</td>
<td>将光标所在行与下一行的数据结合成同一行</td>
</tr>
<tr>
<td>c</td>
<td>重复删除多个数据，例如向下删除 10 行，[ 10cj ]</td>
</tr>
<tr>
<td>u</td>
<td>复原前一个动作。(常用)</td>
</tr>
<tr>
<td>[Ctrl]+r</td>
<td>重做上一个动作。(常用)</td>
</tr>
<tr>
<td>这个 u 与 [Ctrl]+r 是很常用的指令！一个是复原，另一个则是重做一次～</td>
<td></td>
</tr>
<tr>
<td>.</td>
<td>不要怀疑！这就是小数点！意思是重复前一个动作的意思。 如果你想要重复删除、重复贴上等等动作，按下小数点『.』就好了！ (常用)</td>
</tr>
</tbody></table>
<h3 id="搜索替换"><a href="#搜索替换" class="headerlink" title="搜索替换"></a>搜索替换</h3><table>
<thead>
<tr>
<th>/word</th>
<th>向光标之下寻找一个名称为 word 的字符串。例如要在档案内搜寻 vbird 这个字符串，就输入 /vbird 即可！ (常用)</th>
</tr>
</thead>
<tbody><tr>
<td>?word</td>
<td>向光标之上寻找一个字符串名称为 word 的字符串。</td>
</tr>
<tr>
<td>n</td>
<td>这个 n 是英文按键。代表重复前一个搜寻的动作。举例来说， 如果刚刚我们执行 /vbird 去向下搜寻 vbird 这个字符串，则按下 n 后，会向下继续搜寻下一个名称为 vbird 的字符串。如果是执行 ?vbird 的话，那么按下 n 则会向上继续搜寻名称为 vbird 的字符串！</td>
</tr>
<tr>
<td>N</td>
<td>这个 N 是英文按键。与 n 刚好相反，为『反向』进行前一个搜寻动作。 例如 /vbird 后，按下 N 则表示『向上』搜寻 vbird 。</td>
</tr>
<tr>
<td>使用 /word 配合 n 及 N 是非常有帮助的！可以让你重复的找到一些你搜寻的关键词！</td>
<td></td>
</tr>
<tr>
<td>:n1,n2s/word1/word2/g</td>
<td>n1 与 n2 为数字。在第 n1 与 n2 行之间寻找 word1 这个字符串，并将该字符串取代为 word2 ！举例来说，在 100 到 200 行之间搜寻 vbird 并取代为 VBIRD 则： 『:100,200s/vbird/VBIRD/g』。(常用)</td>
</tr>
<tr>
<td><strong>:1,$s/word1/word2/g</strong> 或 <strong>:%s/word1/word2/g</strong></td>
<td>从第一行到最后一行寻找 word1 字符串，并将该字符串取代为 word2 ！(常用)</td>
</tr>
<tr>
<td><strong>:1,$s/word1/word2/gc</strong> 或 <strong>:%s/word1/word2/gc</strong></td>
<td>从第一行到最后一行寻找 word1 字符串，并将该字符串取代为 word2 ！且在取代前显示提示字符给用户确认 (confirm) 是否需要取代！(常用)</td>
</tr>
</tbody></table>
<h2 id="一般模式切换到编辑模式"><a href="#一般模式切换到编辑模式" class="headerlink" title="一般模式切换到编辑模式"></a>一般模式切换到编辑模式</h2><table>
<thead>
<tr>
<th align="left">进入输入或取代的编辑模式</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left">i, I</td>
<td>进入输入模式(Insert mode)： i 为『从目前光标所在处输入』， I 为『在目前所在行的第一个非空格符处开始输入』。 (常用)</td>
</tr>
<tr>
<td align="left">a, A</td>
<td>进入输入模式(Insert mode)： a 为『从目前光标所在的下一个字符处开始输入』， A 为『从光标所在行的最后一个字符处开始输入』。(常用)</td>
</tr>
<tr>
<td align="left">o, O</td>
<td>进入输入模式(Insert mode)： 这是英文字母 o 的大小写。o 为『在目前光标所在的下一行处输入新的一行』； O 为在目前光标所在处的上一行输入新的一行！(常用)</td>
</tr>
<tr>
<td align="left">r, R</td>
<td>进入取代模式(Replace mode)： r 只会取代光标所在的那一个字符一次；R会一直取代光标所在的文字，直到按下 ESC 为止；(常用)</td>
</tr>
<tr>
<td align="left">上面这些按键中，在 vi 画面的左下角处会出现『–INSERT–』或『–REPLACE–』的字样。 由名称就知道该动作了吧！！特别注意的是，我们上面也提过了，你想要在档案里面输入字符时， 一定要在左下角处看到 INSERT 或 REPLACE 才能输入喔！</td>
<td></td>
</tr>
<tr>
<td align="left">[Esc]</td>
<td>退出编辑模式，回到一般模式中(常用)</td>
</tr>
</tbody></table>
<h2 id="一般模式切换到指令行模式"><a href="#一般模式切换到指令行模式" class="headerlink" title="一般模式切换到指令行模式"></a>一般模式切换到指令行模式</h2><table>
<thead>
<tr>
<th align="left">指令行的储存、离开等指令</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left">:w</td>
<td>将编辑的数据写入硬盘档案中(常用)</td>
</tr>
<tr>
<td align="left">:w!</td>
<td>若文件属性为『只读』时，强制写入该档案。不过，到底能不能写入， 还是跟你对该档案的档案权限有关啊！</td>
</tr>
<tr>
<td align="left">:q</td>
<td>离开 vi (常用)</td>
</tr>
<tr>
<td align="left">:q!</td>
<td>若曾修改过档案，又不想储存，使用 ! 为强制离开不储存档案。</td>
</tr>
<tr>
<td align="left">注意一下啊，那个惊叹号 (!) 在 vi 当中，常常具有『强制』的意思～</td>
<td></td>
</tr>
<tr>
<td align="left">:wq</td>
<td>储存后离开，若为 :wq! 则为强制储存后离开 (常用)</td>
</tr>
<tr>
<td align="left">ZZ</td>
<td>这是大写的 Z 喔！若档案没有更动，则不储存离开，若档案已经被更动过，则储存后离开！</td>
</tr>
<tr>
<td align="left">:w [filename]</td>
<td>将编辑的数据储存成另一个档案（类似另存新档）</td>
</tr>
<tr>
<td align="left">:r [filename]</td>
<td>在编辑的数据中，读入另一个档案的数据。亦即将 『filename』 这个档案内容加到游标所在行后面</td>
</tr>
<tr>
<td align="left">:n1,n2 w [filename]</td>
<td>将 n1 到 n2 的内容储存成 filename 这个档案。</td>
</tr>
<tr>
<td align="left">:! command</td>
<td>暂时离开 vi 到指令行模式下执行 command 的显示结果！例如 『:! ls /home』即可在 vi 当中察看 /home 底下以 ls 输出的档案信息！</td>
</tr>
<tr>
<td align="left">vim 环境的变更</td>
<td></td>
</tr>
<tr>
<td align="left">:set nu</td>
<td>显示行号，设定之后，会在每一行的前缀显示该行的行号</td>
</tr>
<tr>
<td align="left">:set nonu</td>
<td>与 set nu 相反，为取消行号！</td>
</tr>
</tbody></table>
<h2 id="区域选择-lt-action-gt-a-lt-object-gt-或-lt-action-gt-i-lt-object-gt"><a href="#区域选择-lt-action-gt-a-lt-object-gt-或-lt-action-gt-i-lt-object-gt" class="headerlink" title="区域选择 &lt;action&gt;a&lt;object&gt; 或 &lt;action&gt;i&lt;object&gt;"></a>区域选择 <code>&lt;action&gt;a&lt;object&gt;</code> 或 <code>&lt;action&gt;i&lt;object&gt;</code></h2><p>在visual 模式下，这些命令很强大，其命令格式为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;action&gt;a&lt;object&gt;` 和 `&lt;action&gt;i&lt;object&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>action可以是任何的命令，如 <code>d</code> (删除), <code>y</code> (拷贝), <code>v</code> (可以视模式选择)。</li>
<li>object 可能是： <code>w</code> 一个单词， <code>W</code> 一个以空格为分隔的单词， <code>s</code> 一个句字， <code>p</code> 一个段落。也可以是一个特别的字符：<code>&quot;、</code> <code>&#39;、</code> <code>)、</code> <code>}、</code> <code>]。</code></li>
</ul>
<p>假设你有一个字符串 <code>(map (+) (&quot;foo&quot;))</code>.而光标键在第一个 <code>o</code>的位置。</p>
<blockquote>
<ul>
<li><code>vi&quot;</code> → 会选择 <code>foo</code>.</li>
<li><code>va&quot;</code> → 会选择 <code>&quot;foo&quot;</code>.</li>
<li><code>vi)</code> → 会选择 <code>&quot;foo&quot;</code>.</li>
<li><code>va)</code> → 会选择<code>(&quot;foo&quot;)</code>.</li>
<li><code>v2i)</code> → 会选择 <code>map (+) (&quot;foo&quot;)</code></li>
<li><code>v2a)</code> → 会选择 <code>(map (+) (&quot;foo&quot;))</code></li>
</ul>
</blockquote>
<h2 id="块操作-lt-C-v-gt"><a href="#块操作-lt-C-v-gt" class="headerlink" title="块操作: &lt;C-v&gt;"></a>块操作: <code>&lt;C-v&gt;</code></h2><p>块操作，典型的操作： <code>0 &lt;C-v&gt; &lt;C-d&gt; I-- [ESC]</code></p>
<ul>
<li><p><code>^</code> → 到行头</p>
</li>
<li><p><code>&lt;C-v&gt;</code> → 开始块操作</p>
</li>
<li><p><code>&lt;C-d&gt;</code> → 向下移动 (你也可以使用hjkl来移动光标，或是使用%，或是别的)</p>
</li>
<li><p><code>I-- [ESC]</code> → I是插入，插入“<code>--</code>”，按ESC键来为每一行生效。</p>
</li>
</ul>
<h2 id="自动提示：-lt-C-n-gt-和-lt-C-p-gt"><a href="#自动提示：-lt-C-n-gt-和-lt-C-p-gt" class="headerlink" title="自动提示： &lt;C-n&gt; 和 &lt;C-p&gt;"></a>自动提示： <code>&lt;C-n&gt;</code> 和 <code>&lt;C-p&gt;</code></h2><p>在 Insert 模式下，你可以输入一个词的开头，然后按 <code>&lt;C-p&gt;或是&lt;C-n&gt;，自动补齐功能就出现了……</code></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li>简明 VIM 练级攻略: <a href="https://coolshell.cn/articles/5426.html" target="_blank" rel="noopener">https://coolshell.cn/articles/5426.html</a></li>
<li>Vim使用笔记: <a href="https://www.cnblogs.com/jiqingwu/archive/2012/06/14/vim_notes.html" target="_blank" rel="noopener">https://www.cnblogs.com/jiqingwu/archive/2012/06/14/vim_notes.html</a></li>
<li>Vim命令合集: <a href="https://www.jianshu.com/p/117253829581" target="_blank" rel="noopener">https://www.jianshu.com/p/117253829581</a></li>
</ol>
<p>### </p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/05/grep-command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/05/grep-command/" class="post-title-link" itemprop="url">grep命令</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-05 20:09:44" itemprop="dateCreated datePublished" datetime="2019-08-05T20:09:44+08:00">2019-08-05</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-06 10:24:38" itemprop="dateModified" datetime="2019-08-06T10:24:38+08:00">2019-08-06</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/" itemprop="url" rel="index"><span itemprop="name">linux命令</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/grep命令/" itemprop="url" rel="index"><span itemprop="name">grep命令</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">171</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">1 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><h3 id="grep命令"><a href="#grep命令" class="headerlink" title="grep命令"></a>grep命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-c 统计包含匹配字符串的行数。</span><br><span class="line">-i 忽略字符大小写的差别。</span><br><span class="line">-v 反转查找。</span><br><span class="line">-o 只输出文件中匹配到的部分。</span><br><span class="line">-E 将范本样式为延伸的普通表示法来使用，意味着使用能使用扩展正则表达式。</span><br><span class="line">-r 递归查找。</span><br></pre></td></tr></table></figure>

<p><a href="https://www.gnu.org/savannah-checkouts/gnu/grep/manual/grep.html" target="_blank" rel="noopener">GNU Grep用法</a></p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">"test[53]"</span> jfedu.txt 		以字符<span class="built_in">test</span>开头，接5或者3的行</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/05/linux-command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/05/linux-command/" class="post-title-link" itemprop="url">linux基本命令</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-05 18:23:29" itemprop="dateCreated datePublished" datetime="2019-08-05T18:23:29+08:00">2019-08-05</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-09 11:02:15" itemprop="dateModified" datetime="2019-08-09T11:02:15+08:00">2019-08-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/" itemprop="url" rel="index"><span itemprop="name">linux命令</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/linux基本命令/" itemprop="url" rel="index"><span itemprop="name">linux基本命令</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">1.7k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">2 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="sort-排序"><a href="#sort-排序" class="headerlink" title="sort: 排序"></a>sort: 排序</h2><p><code>sort</code> 命令的用法很简单。最基本的用法有两种：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat data.txt | sort</span><br><span class="line">sort data.txt</span><br></pre></td></tr></table></figure>

<p>选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-r  倒序</span><br><span class="line">-f	忽略字母大小写</span><br></pre></td></tr></table></figure>

<p><code>-k</code> 指定用于排序的栏目范围，<code>-t</code> 指定栏目的分隔符。</p>
<p>以下实例，用<code>:</code>分割行，排序值从第3栏开始：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sort -k 3 -t : sort.txt</span><br><span class="line">aaa:30:1.6</span><br><span class="line">bbb:10:2.5</span><br><span class="line">ccc:50:3.3</span><br><span class="line">ddd:20:4.2</span><br><span class="line">eee:60:5.1</span><br><span class="line">eee:40:5.4</span><br></pre></td></tr></table></figure>

<h2 id="uniq-重复"><a href="#uniq-重复" class="headerlink" title="uniq: 重复"></a>uniq: 重复</h2><p><code>uniq</code> 的作用可以描述为：针对相邻的重复行，进行相应的动作。</p>
<p>这句话中，有两个地方需要注意。首先，针对的是<strong>相邻的重复行</strong>。因此，<code>uniq</code> 对于不相邻的重复行是不起作用的。其次，进行<strong>相应的</strong>动作。这意味着，<code>uniq</code> 可以做的事情很多，不止一样。</p>
<p>不带任何参数的时候 <code>uniq</code> 的动作是：对相邻的重复行进行去除。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;filename&gt; | sort | uniq</span><br></pre></td></tr></table></figure>

<p>我们已经见过了 <code>sort</code> 的作用，那么上面命令的作用就很显然了：将 <code>&lt;filename&gt;</code> 按照 ASCII 升序排序；然后去除重复出现的行；最后将这个没有重复行的内容输出到标准输出。</p>
<p>给 <code>uniq</code> 加上参数，就能解锁更多姿势。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;filename&gt; | sort | uniq -d     <span class="comment"># 只显示重复的行，每行只显示一次</span></span><br><span class="line">cat &lt;filename&gt; | sort | uniq -D     <span class="comment"># 只显示重复的行</span></span><br><span class="line">cat &lt;filename&gt; | sort | uniq -i     <span class="comment"># 忽略大小写</span></span><br><span class="line">cat &lt;filename&gt; | sort | uniq -u     <span class="comment"># 只显示只出现一次的行</span></span><br><span class="line">cat &lt;filename&gt; | sort | uniq -c     <span class="comment"># 统计每行重复的次数</span></span><br></pre></td></tr></table></figure>

<h2 id="xargs-将标准输入转为命令行参数"><a href="#xargs-将标准输入转为命令行参数" class="headerlink" title="xargs: 将标准输入转为命令行参数"></a>xargs: 将标准输入转为命令行参数</h2><p>Unix有些命令可以接受”标准输入”（stdin）作为参数。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; $ cat /etc/passwd | grep root</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面的代码使用了管道命令（<code>|</code>）。管道命令的作用，是将左侧命令（<code>cat /etc/passwd</code>）的标准输出转换为标准输入，提供给右侧命令（<code>grep root</code>）作为参数。</p>
<p>但是，大多数命令都不接受标准输入作为参数，只能直接在命令行输入参数，这导致无法用管道命令传递参数。举例来说，<code>echo</code>命令就不接受管道传参。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; $ <span class="built_in">echo</span> <span class="string">"hello world"</span> | <span class="built_in">echo</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面的代码不会有输出。因为管道右侧的<code>echo</code>不接受管道传来的标准输入作为参数。</p>
<p><code>xargs</code>命令的作用，是将标准输入转为命令行参数。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; $ <span class="built_in">echo</span> <span class="string">"hello world"</span> | xargs <span class="built_in">echo</span></span><br><span class="line">&gt; hello world</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面的代码将管道左侧的标准输入，转为命令行参数<code>hello world</code>，传给第二个<code>echo</code>命令。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ol>
<li>查找所有后辍为txt的文件列表，然后进行grep: </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . -name <span class="string">"*.txt"</span> | xargs grep <span class="string">"abc"</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>由于<code>xargs</code>默认将空格作为分隔符，所以不太适合处理文件名，因为文件名可能包含空格。</li>
</ol>
<p><code>find</code>命令有一个特别的参数<code>-print0</code>，指定输出的文件列表以<code>null</code>分隔。然后，<code>xargs</code>命令的<code>-0</code>参数表示用<code>null</code>当作分隔符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -name <span class="string">"*.log"</span> -print0 | xargs -0 rm -f</span><br></pre></td></tr></table></figure>

<p>统计一个源代码目录中所有 php 文件的行数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -name <span class="string">"*.php"</span> -print0 | xargs -0 wc -l</span><br></pre></td></tr></table></figure>

<p>查找所有的 jpg 文件，并且压缩它们：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -name <span class="string">"*.jpg"</span> -<span class="built_in">print</span> | xargs tar -czvf images.tar.gz</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/05/awk-syntax/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/05/awk-syntax/" class="post-title-link" itemprop="url">awk用法</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-05 17:28:29" itemprop="dateCreated datePublished" datetime="2019-08-05T17:28:29+08:00">2019-08-05</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-06 10:23:55" itemprop="dateModified" datetime="2019-08-06T10:23:55+08:00">2019-08-06</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/" itemprop="url" rel="index"><span itemprop="name">linux命令</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux命令/awk命令/" itemprop="url" rel="index"><span itemprop="name">awk命令</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">7.7k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">7 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk [options] <span class="string">'pattern &#123;action&#125;'</span> file...</span><br></pre></td></tr></table></figure>

<p><code>awk</code>的工作过程是这样的：按行读取输入(标准输入或文件)，对于符合模式<code>pattern</code>的行，执行<code>action</code>。当<code>pattern</code>省略时表示匹配任何字符串；当<code>action</code>省略时表示执行<code>&#39;{print}&#39;</code>；它们不可以同时省略。</p>
<p>模式可以是以下任意一个：</p>
<ul>
<li>/正则表达式/：使用通配符的扩展集。</li>
<li>关系表达式：使用运算符进行操作，可以是字符串或数字的比较测试。</li>
<li>模式匹配表达式：用运算符<code>~</code>(匹配) 和 <code>~!</code>(不匹配)。</li>
<li>BEGIN语句块、pattern语句块、END语句块</li>
</ul>
<p>每一行输入，对<code>awk</code>来说都是一条记录(<code>record</code>)，<code>awk</code>使用<code>$0</code>来引用当前记录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># head -1 /etc/passwd | awk '&#123;print $0&#125;'</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure>

<p>例子中将命令<code>head -1 /etc/passwd</code>作为<code>awk</code>的输入，<code>awk</code>省略了<code>pattern</code>，<code>action</code>为<code>print $0</code>，意为打印当前记录。<br>对于每条记录，<code>awk</code>使用分隔符将其分割成列，第一列用<code>$1</code>表示，第二列用<code>$2</code>表示…最后一列用<code>$NF</code>表示</p>
<p>选项<code>-F</code>表示指定分隔符<br>如输出文件<code>/etc/passwd</code>第一行第一列(用户名)和最后一列(登录shell)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># head -1 /etc/passwd | awk -F: '&#123;print $1,$NF&#125;'</span></span><br><span class="line">root /bin/bash</span><br></pre></td></tr></table></figure>

<p>当没有指定分隔符时，使用一到多个<code>blank</code>(空白字符，由空格键或TAB键产生)作为分隔符。输出的分隔符默认为空格。<br>如输出命令<code>ls -l *</code>的结果中，文件大小和文件名：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># ls -l * | awk '&#123;print $5,$NF&#125;'</span></span><br><span class="line">13 b.txt</span><br><span class="line">58 c.txt</span><br><span class="line">12 d.txt</span><br><span class="line">0 e.txt</span><br><span class="line">0 f.txt</span><br><span class="line">24 test.sh</span><br></pre></td></tr></table></figure>

<p>还可以对任意列进行过滤：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># ls -l *|awk '$5&gt;20 &amp;&amp; $NF ~ /txt$/'</span></span><br><span class="line">-rw-r--r-- 1 nobody nobody 58 11月 16 16:34 c.txt</span><br></pre></td></tr></table></figure>

<p>其中<code>$5&gt;20</code>表示第五列的值大于20；<code>&amp;&amp;</code>表示逻辑与；<code>$NF ~ /txt$/</code>中，<code>~</code>表示匹配，符号<code>//</code>内部是正则表达式。这里省略了<code>action</code>，整条awk语句表示打印文件大小大于20字节并且文件名以txt结尾的行。</p>
<p><code>awk</code>用<code>NR</code>表示行号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># awk '/^root/ || NR==2' /etc/passwd</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p>例子中<code>||</code>表示逻辑或，语句表示：输出文件<code>/etc/passwd</code>中以root开头的行或者第二行。</p>
<p>在一些情况下，使用<code>awk</code>过滤甚至比使用<code>grep</code>更灵活<br>如获得<code>ifconfig</code>的输出中网卡名及其对应的mtu值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@idc-v-71253 ~]<span class="comment"># ifconfig|awk '/^\S/&#123;print $1"\t"$NF&#125;'</span></span><br><span class="line">ens32:  1500</span><br><span class="line">ens33:  1500</span><br><span class="line">lo:     65536</span><br><span class="line"><span class="comment">#这里的正则表示不以空白字符开头的行，输出内容中使用\t进行了格式化。</span></span><br></pre></td></tr></table></figure>

<p>以上所说的<code>NR</code>、<code>NF</code>等都是awk的内建变量，下面列出部分常用内置变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$0</span>          当前记录（这个变量中存放着整个行的内容）</span><br><span class="line"><span class="variable">$1</span>~<span class="variable">$n</span>       当前记录的第n个字段，字段间由FS分隔</span><br><span class="line">FS          输入字段分隔符 默认是空格或Tab</span><br><span class="line">NF          当前记录中的字段个数，就是有多少列</span><br><span class="line">NR          行号，从1开始，如果有多个文件话，这个值也不断累加。</span><br><span class="line">FNR         输入文件行号</span><br><span class="line">RS          输入的记录分隔符， 默认为换行符</span><br><span class="line">OFS         输出字段分隔符， 默认也是空格</span><br><span class="line">ORS         输出的记录分隔符，默认为换行符</span><br><span class="line">FILENAME    当前输入文件的名字</span><br></pre></td></tr></table></figure>

<p><code>awk</code>中还可以使用自定义变量，如将网卡名赋值给变量a，然后输出网卡名及其对应的<code>RX bytes</code>的值(注意不同模式匹配及其action的写法)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@idc-v-71253 ~]<span class="comment"># ifconfig|awk '/^\S/&#123;a=$1&#125;/RX p/&#123;print a,$5&#125;'</span></span><br><span class="line">ens32: 999477100</span><br><span class="line">ens33: 1663197120</span><br><span class="line">lo: 0</span><br></pre></td></tr></table></figure>

<p><code>awk</code>中有两个特殊的pattern：<code>BEGIN</code>和<code>END</code>；它们不会对输入文本进行匹配，<code>BEGIN</code>对应的<code>action</code>部分组合成一个代码块，在任何输入开始之前执行；<code>END</code>对应的<code>action</code>部分组合成一个代码块，在所有输入处理完成之后执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意类似于C语言的赋值及print函数用法</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># ls -l *|awk 'BEGIN&#123;print "size name\n---------"&#125;$5&gt;20&#123;x+=$5;print $5,$NF&#125;END&#123;print "---------\ntotal",x&#125;'</span></span><br><span class="line">size name</span><br><span class="line">---------</span><br><span class="line">58 c.txt</span><br><span class="line">24 test.sh</span><br><span class="line">---------</span><br><span class="line">total 82</span><br></pre></td></tr></table></figure>

<p>再来看看统计每个用户的进程的占了多少内存（注：sum的RSS那一列）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ps aux | awk &apos;NR!=1&#123;a[$1]+=$6;&#125; END &#123; for(i in a) print i &quot;, &quot; a[i]&quot;KB&quot;;&#125;&apos;</span><br><span class="line">dbus, 540KB</span><br><span class="line">mysql, 99928KB</span><br><span class="line">www, 3264924KB</span><br><span class="line">root, 63644KB</span><br><span class="line">hchen, 6020KB</span><br></pre></td></tr></table></figure>

<p><code>awk</code>还支持数组，数组的索引都被视为字符串(即关联数组)，可以使用<code>for</code>循环遍历数组元素<br>如输出文件<code>/etc/passwd</code>中各种登录shell及其总数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意数组赋值及for循环遍历数组的写法</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># awk -F ':' '&#123;a[$NF]++&#125;END&#123;for(i in a) print i,a[i]&#125;' /etc/passwd</span></span><br><span class="line">/bin/sync 1</span><br><span class="line">/bin/bash 2</span><br><span class="line">/sbin/nologin 19</span><br><span class="line">/sbin/halt 1</span><br><span class="line">/sbin/shutdown 1</span><br></pre></td></tr></table></figure>

<p>当然也有<code>if</code>分支语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意大括号是如何界定action块的</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># netstat -antp|awk '&#123;if($6=="LISTEN")&#123;x++&#125;else&#123;y++&#125;&#125;END&#123;print x,y&#125;'</span></span><br><span class="line">6 3</span><br></pre></td></tr></table></figure>

<p><code>pattern</code>之间可以用逗号分隔，表示从匹配第一个模式开始直到匹配第二个模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># awk '/^root/,/^adm/' /etc/passwd       </span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p>还支持三目操作符<code>pattern1 ? pattern2 : pattern3</code>，表示判断pattern1是否匹配，true则匹配pattern2，false则匹配pattern3，pattern也可以是类似C语言的表达式。<br>如判断文件<code>/etc/passwd</code>中UID大于500的登录shell是否为/bin/bash，是则输出整行，否则输出UID为0的行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意为避免混淆对目录分隔符进行了转义</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -F: '$3&gt;500?/\/bin\/bash$/:$3==0 &#123;print $0&#125;' /etc/passwd         </span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">learner:x:1000:1000::/home/learner:/bin/bash</span><br><span class="line"><span class="comment">#三目运算符也可以嵌套，例子略</span></span><br></pre></td></tr></table></figure>

<p>选项<code>-f file</code>表示从file中读取awk指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#打印斐波那契数列前十项</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># cat test.awk </span></span><br><span class="line">BEGIN&#123;</span><br><span class="line">    <span class="variable">$1</span>=1</span><br><span class="line">    <span class="variable">$2</span>=1</span><br><span class="line">    OFS=<span class="string">","</span></span><br><span class="line">    <span class="keyword">for</span>(i=3;i&lt;=10;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$i</span>=$(i-2)+$(i-1)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span></span><br><span class="line">&#125;</span><br><span class="line">[root@centos7 temp]<span class="comment"># awk -f test.awk </span></span><br><span class="line">1,1,2,3,5,8,13,21,34,55</span><br></pre></td></tr></table></figure>

<p>选项<code>-F</code>指定列分隔符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#多个字符作为分隔符时</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># echo 1.2,3:4 5|awk -F '[., :]' '&#123;print $2,$NF&#125;'</span></span><br><span class="line">2 5</span><br><span class="line"><span class="comment">#这里-F后单引号中的内容也是正则表达式</span></span><br></pre></td></tr></table></figure>

<p>选项<code>-v var=val</code>设定变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里printf函数用法类似C语言同名函数</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># awk -v n=5 'BEGIN&#123;for(i=0;i&lt;n;i++) printf "%02d\n",i&#125;'  </span></span><br><span class="line">00</span><br><span class="line">01</span><br><span class="line">02</span><br><span class="line">03</span><br><span class="line">04</span><br></pre></td></tr></table></figure>

<p><code>print</code>等函数还支持使用重定向符<code>&gt;</code>和<code>&gt;&gt;</code>将输出保存至文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如按第一列(IP)分类拆分文件access.log，并保存至ip.txt文件中</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># awk '&#123;print &gt; $1".txt"&#125;' access.log </span></span><br><span class="line">[root@centos7 temp]<span class="comment"># ls -l 172.20.71.*</span></span><br><span class="line">-rw-r--r-- 1 root root 5297 11月 22 21:33 172.20.71.38.txt</span><br><span class="line">-rw-r--r-- 1 root root 1236 11月 22 21:33 172.20.71.39.txt</span><br><span class="line">-rw-r--r-- 1 root root 4533 11月 22 21:33 172.20.71.84.txt</span><br><span class="line">-rw-r--r-- 1 root root 2328 11月 22 21:33 172.20.71.85.txt</span><br></pre></td></tr></table></figure>

<h2 id="内建函数"><a href="#内建函数" class="headerlink" title="内建函数"></a>内建函数</h2><p>length()获得字符串长度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># awk -F: '&#123;if(length($1)&gt;=16)print&#125;' /etc/passwd </span></span><br><span class="line">systemd-bus-proxy:x:999:997:systemd Bus Proxy:/:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p><code>split()</code>将字符串按分隔符分隔，并保存至数组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># head -1 /etc/passwd|awk '&#123;split($0,arr,/:/);for(i=1;i&lt;=length(arr);i++) print arr[i]&#125;'</span></span><br><span class="line">root</span><br><span class="line">x</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">root</span><br><span class="line">/root</span><br><span class="line">/bin/bash</span><br></pre></td></tr></table></figure>

<p><code>getline</code>从输入(可以是管道、另一个文件或当前文件的下一行)中获得记录，赋值给变量或重置某些环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从shell命令date中通过管道获得当前的小时数</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># awk 'BEGIN&#123;"date"|getline;split($5,arr,/:/);print arr[1]&#125;'</span></span><br><span class="line">09</span><br><span class="line"><span class="comment">#从文件中获取，此时会覆盖当前的$0。(注意逐行处理b.txt的同时也在逐行从c.txt中获得记录并覆盖$0，当getline先遇到eof时&lt;即c.txt文件行数较少&gt;将输出空行)</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># awk '&#123;getline &lt;"c.txt";print $4&#125;' b.txt </span></span><br><span class="line"><span class="string">"https://segmentfault.com/blog/learnning"</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># </span></span><br><span class="line"><span class="comment">#赋值给变量</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># awk '&#123;getline blog &lt;"c.txt";print $0"\n"blog&#125;' b.txt </span></span><br><span class="line">aasdasdadsad</span><br><span class="line">BLOG ADDRESS IS <span class="string">"https://segmentfault.com/blog/learnning"</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># </span></span><br><span class="line"><span class="comment">#读取下一行(也会覆盖当前$0)</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># cat file</span></span><br><span class="line">anny</span><br><span class="line">100</span><br><span class="line">bob</span><br><span class="line">150</span><br><span class="line">cindy</span><br><span class="line">120</span><br><span class="line">[root@centos7 temp]<span class="comment"># awk '&#123;getline;total+=$0&#125;END&#123;print total&#125;' file</span></span><br><span class="line">370</span><br><span class="line"><span class="comment">#此时表示只对偶数行进行处理</span></span><br></pre></td></tr></table></figure>

<p><code>next</code>作用和getline类似，也是读取下一行并覆盖$0，区别是next执行后，其后的命令不再执行，而是读取下一行从头再执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#跳过以a-s开头的行，统计行数，打印最终结果</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># awk '/^[a-s]/&#123;next&#125;&#123;count++&#125;END&#123;print count&#125;' /etc/passwd</span></span><br><span class="line">2</span><br><span class="line">[root@centos7 temp]<span class="comment"># </span></span><br><span class="line"><span class="comment">#又如合并相同列的两个文件</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># cat f.txt </span></span><br><span class="line">学号 分值</span><br><span class="line">00001 80</span><br><span class="line">00002 75</span><br><span class="line">00003 90</span><br><span class="line">[root@centos7 temp]<span class="comment"># cat e.txt </span></span><br><span class="line">姓名 学号</span><br><span class="line">张三 00001</span><br><span class="line">李四 00002</span><br><span class="line">王五 00003</span><br><span class="line">[root@centos7 temp]<span class="comment"># awk 'NR==FNR&#123;a[$1]=$2;next&#125;&#123;print $0,a[$2]&#125;' f.txt e.txt   </span></span><br><span class="line">姓名 学号 分值</span><br><span class="line">张三 00001 80</span><br><span class="line">李四 00002 75</span><br><span class="line">王五 00003 90</span><br><span class="line"><span class="comment">#这里当读第一个文件时NR==FNR成立，执行a[$1]=$2，然后next忽略后面的。读取第二个文件时，NR==FNR不成立，执行后面的打印命令</span></span><br></pre></td></tr></table></figure>

<p><code>sub(regex,substr,string)</code>替换字符串string(省略时为$0)中首个出现匹配正则regex的子串substr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># echo 178278 world|awk 'sub(/[0-9]+/,"hello")'</span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<p><code>gsub(regex,substr,string)</code>与sub()类似，但不止替换第一个，而是全局替换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># head -n5 /etc/passwd|awk '&#123;gsub(/[0-9]+/,"----");print $0&#125;'     </span></span><br><span class="line">root:x:----:----:root:/root:/bin/bash</span><br><span class="line">bin:x:----:----:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:----:----:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:----:----:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:----:----:lp:/var/spool/lpd:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p><code>substr(str,n,m)</code>切割字符串str，从第n个字符开始，切割m个。如果m省略，则到结尾</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># echo "hello,世界！"|awk '&#123;print substr($0,8,1)&#125;'</span></span><br><span class="line">界</span><br></pre></td></tr></table></figure>

<p><code>tolower(str)</code>和<code>toupper(str)</code>表示大小写转换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># echo "hello,世界！"|awk '&#123;A=toupper($0);print A&#125;'</span></span><br><span class="line">HELLO,世界！</span><br></pre></td></tr></table></figure>

<p><code>system(cmd)</code>执行shell命令cmd，返回执行结果，执行成功为0，失败为非0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此处if语句判断和C语言一致，0为false，非0为true</span></span><br><span class="line">[root@centos7 temp]<span class="comment"># awk 'BEGIN&#123;if(!system("date&gt;/dev/null"))print "success"&#125;'</span></span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<p><code>match(str,regex)</code>返回字符串str中匹配正则regex的位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 temp]<span class="comment"># awk 'BEGIN&#123;A=match("abc.f.11.12.1.98",/[0-9]&#123;1,3&#125;\./);print A&#125;'</span></span><br><span class="line">7</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><ul>
<li>条件统计</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'$2&gt;=6 &amp;&amp; $2&lt;20 &#123; tot++ &#125; END &#123; print +tot&#125;'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>花式用法</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#按连接数查看客户端IP</span></span><br><span class="line">netstat -ntu | awk <span class="string">'&#123;print $5&#125;'</span> | cut -d: -f1 | sort | uniq -c | sort -nr</span><br><span class="line"> </span><br><span class="line"><span class="comment">#打印99乘法表</span></span><br><span class="line">seq 9 | sed <span class="string">'H;g'</span> | awk -v RS=<span class="string">''</span> <span class="string">'&#123;for(i=1;i&lt;=NF;i++)printf("%dx%d=%d%s", i, NR, i*NR, i==NR?"\n":"\t")&#125;'</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/08/05/regexp-syntax/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/05/regexp-syntax/" class="post-title-link" itemprop="url">正则表达式</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-05 15:17:30" itemprop="dateCreated datePublished" datetime="2019-08-05T15:17:30+08:00">2019-08-05</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-06 10:36:04" itemprop="dateModified" datetime="2019-08-06T10:36:04+08:00">2019-08-06</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/正则表达式/" itemprop="url" rel="index"><span itemprop="name">正则表达式</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">3.4k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">3 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h2><table>
<thead>
<tr>
<th align="left">字符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">\</td>
<td align="left">将下一个字符标记为一个特殊字符、或一个原义字符、或一个 向后引用、或一个八进制转义符。例如，’n’ 匹配字符 “n”。’\n’ 匹配一个换行符。序列 ‘\‘ 匹配 “&quot; 而 “(“ 则匹配 “(“。</td>
</tr>
<tr>
<td align="left">^</td>
<td align="left">匹配输入字符串的开始位置。如果设置了 RegExp 对象的 Multiline 属性，^ 也匹配 ‘\n’ 或 ‘\r’ 之后的位置。</td>
</tr>
<tr>
<td align="left">$</td>
<td align="left">匹配输入字符串的结束位置。如果设置了RegExp 对象的 Multiline 属性，$ 也匹配 ‘\n’ 或 ‘\r’ 之前的位置。</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">匹配前面的子表达式零次或多次。例如，zo* 能匹配 “z” 以及 “zoo”。* 等价于{0,}。</td>
</tr>
<tr>
<td align="left">+</td>
<td align="left">匹配前面的子表达式一次或多次。例如，’zo+’ 能匹配 “zo” 以及 “zoo”，但不能匹配 “z”。+ 等价于 {1,}。</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">匹配前面的子表达式零次或一次。例如，”do(es)?” 可以匹配 “do” 或 “does” 。? 等价于 {0,1}。</td>
</tr>
<tr>
<td align="left">{n}</td>
<td align="left">n 是一个非负整数。匹配确定的 n 次。例如，’o{2}’ 不能匹配 “Bob” 中的 ‘o’，但是能匹配 “food” 中的两个 o。</td>
</tr>
<tr>
<td align="left">{n,}</td>
<td align="left">n 是一个非负整数。至少匹配n 次。例如，’o{2,}’ 不能匹配 “Bob” 中的 ‘o’，但能匹配 “foooood” 中的所有 o。’o{1,}’ 等价于 ‘o+’。’o{0,}’ 则等价于 ‘o*’。</td>
</tr>
<tr>
<td align="left">{n,m}</td>
<td align="left">m 和 n 均为非负整数，其中n &lt;= m。最少匹配 n 次且最多匹配 m 次。例如，”o{1,3}” 将匹配 “fooooood” 中的前三个 o。’o{0,1}’ 等价于 ‘o?’。请注意在逗号和两个数之间不能有空格。</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">当该字符紧跟在任何一个其他限制符 (*, +, ?, {n}, {n,}, {n,m}) 后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。例如，对于字符串 “oooo”，’o+?’ 将匹配单个 “o”，而 ‘o+’ 将匹配所有 ‘o’。</td>
</tr>
<tr>
<td align="left">.</td>
<td align="left">匹配除换行符（\n、\r）之外的任何单个字符。要匹配包括 ‘\n’ 在内的任何字符，请使用像”<strong>(.|\n)</strong>“的模式。</td>
</tr>
<tr>
<td align="left">(pattern)</td>
<td align="left">匹配 pattern 并获取这一匹配。所获取的匹配可以从产生的 Matches 集合得到。要匹配圆括号字符，请使用 ‘(‘ 或 ‘)‘。</td>
</tr>
<tr>
<td align="left">(?:pattern)</td>
<td align="left">匹配 pattern 但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用 “或” 字符 (|) 来组合一个模式的各个部分是很有用。例如， ‘industr(?:y|ies) 就是一个比 ‘industry|industries’ 更简略的表达式。</td>
</tr>
<tr>
<td align="left">(?=pattern)</td>
<td align="left">正向肯定预查（look ahead positive assert），在任何匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，”Windows(?=95|98|NT|2000)”能匹配”Windows2000”中的”Windows”，但不能匹配”Windows3.1”中的”Windows”。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</td>
</tr>
<tr>
<td align="left">(?!pattern)</td>
<td align="left">正向否定预查(negative assert)，在任何不匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如”Windows(?!95|98|NT|2000)”能匹配”Windows3.1”中的”Windows”，但不能匹配”Windows2000”中的”Windows”。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</td>
</tr>
<tr>
<td align="left">(?&lt;=pattern)</td>
<td align="left">反向(look behind)肯定预查，与正向肯定预查类似，只是方向相反。例如，”`(?&lt;=95</td>
</tr>
<tr>
<td align="left">(?&lt;!pattern)</td>
<td align="left">反向否定预查，与正向否定预查类似，只是方向相反。例如”`(?&lt;!95</td>
</tr>
<tr>
<td align="left">x|y</td>
<td align="left">匹配 x 或 y。例如，’z|food’ 能匹配 “z” 或 “food”。’(z|f)ood’ 则匹配 “zood” 或 “food”。</td>
</tr>
<tr>
<td align="left">[xyz]</td>
<td align="left">字符集合。匹配所包含的任意一个字符。例如， ‘[abc]’ 可以匹配 “plain” 中的 ‘a’。</td>
</tr>
<tr>
<td align="left">[^xyz]</td>
<td align="left">负值字符集合。匹配未包含的任意字符。例如， ‘[^abc]’ 可以匹配 “plain” 中的’p’、’l’、’i’、’n’。</td>
</tr>
<tr>
<td align="left">[a-z]</td>
<td align="left">字符范围。匹配指定范围内的任意字符。例如，’[a-z]’ 可以匹配 ‘a’ 到 ‘z’ 范围内的任意小写字母字符。</td>
</tr>
<tr>
<td align="left">[^a-z]</td>
<td align="left">负值字符范围。匹配任何不在指定范围内的任意字符。例如，’[^a-z]’ 可以匹配任何不在 ‘a’ 到 ‘z’ 范围内的任意字符。</td>
</tr>
<tr>
<td align="left">\b</td>
<td align="left">匹配一个单词边界，也就是指单词和空格间的位置。例如， ‘er\b’ 可以匹配”never” 中的 ‘er’，但不能匹配 “verb” 中的 ‘er’。</td>
</tr>
<tr>
<td align="left">\B</td>
<td align="left">匹配非单词边界。’er\B’ 能匹配 “verb” 中的 ‘er’，但不能匹配 “never” 中的 ‘er’。</td>
</tr>
<tr>
<td align="left">\cx</td>
<td align="left">匹配由 x 指明的控制字符。例如， \cM 匹配一个 Control-M 或回车符。x 的值必须为 A-Z 或 a-z 之一。否则，将 c 视为一个原义的 ‘c’ 字符。</td>
</tr>
<tr>
<td align="left">\d</td>
<td align="left">匹配一个数字字符。等价于 [0-9]。</td>
</tr>
<tr>
<td align="left">\D</td>
<td align="left">匹配一个非数字字符。等价于 [^0-9]。</td>
</tr>
<tr>
<td align="left">\f</td>
<td align="left">匹配一个换页符。等价于 \x0c 和 \cL。</td>
</tr>
<tr>
<td align="left">\n</td>
<td align="left">匹配一个换行符。等价于 \x0a 和 \cJ。</td>
</tr>
<tr>
<td align="left">\r</td>
<td align="left">匹配一个回车符。等价于 \x0d 和 \cM。</td>
</tr>
<tr>
<td align="left">\s</td>
<td align="left">匹配任何空白字符，包括空格、制表符、换页符等等。等价于 [ \f\n\r\t\v]。</td>
</tr>
<tr>
<td align="left">\S</td>
<td align="left">匹配任何非空白字符。等价于 [^ \f\n\r\t\v]。</td>
</tr>
<tr>
<td align="left">\t</td>
<td align="left">匹配一个制表符。等价于 \x09 和 \cI。</td>
</tr>
<tr>
<td align="left">\v</td>
<td align="left">匹配一个垂直制表符。等价于 \x0b 和 \cK。</td>
</tr>
<tr>
<td align="left">\w</td>
<td align="left">匹配字母、数字、下划线。等价于’[A-Za-z0-9_]’。</td>
</tr>
<tr>
<td align="left">\W</td>
<td align="left">匹配非字母、数字、下划线。等价于 ‘[^A-Za-z0-9_]’。</td>
</tr>
<tr>
<td align="left">\xn</td>
<td align="left">匹配 n，其中 n 为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，’\x41’ 匹配 “A”。’\x041’ 则等价于 ‘\x04’ &amp; “1”。正则表达式中可以使用 ASCII 编码。</td>
</tr>
<tr>
<td align="left">\num</td>
<td align="left">匹配 num，其中 num 是一个正整数。对所获取的匹配的引用。例如，’(.)\1’ 匹配两个连续的相同字符。</td>
</tr>
<tr>
<td align="left">\n</td>
<td align="left">标识一个八进制转义值或一个向后引用。如果 \n 之前至少 n 个获取的子表达式，则 n 为向后引用。否则，如果 n 为八进制数字 (0-7)，则 n 为一个八进制转义值。</td>
</tr>
<tr>
<td align="left">\nm</td>
<td align="left">标识一个八进制转义值或一个向后引用。如果 \nm 之前至少有 nm 个获得子表达式，则 nm 为向后引用。如果 \nm 之前至少有 n 个获取，则 n 为一个后跟文字 m 的向后引用。如果前面的条件都不满足，若 n 和 m 均为八进制数字 (0-7)，则 \nm 将匹配八进制转义值 nm。</td>
</tr>
<tr>
<td align="left">\nml</td>
<td align="left">如果 n 为八进制数字 (0-3)，且 m 和 l 均为八进制数字 (0-7)，则匹配八进制转义值 nml。</td>
</tr>
<tr>
<td align="left">\un</td>
<td align="left">匹配 n，其中 n 是一个用四个十六进制数字表示的 Unicode 字符。例如， \u00A9 匹配版权符号 (?)。</td>
</tr>
</tbody></table>
<h2 id="常用正则表达式收集"><a href="#常用正则表达式收集" class="headerlink" title="常用正则表达式收集"></a>常用正则表达式收集</h2><ol>
<li><p><a href="https://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html" target="_blank" rel="noopener">最全的常用正则表达式大全——包括校验数字、字符、一些特殊的需求等</a></p>
</li>
<li><p><a href="https://github.com/cdoco/common-regex" target="_blank" rel="noopener">常用正则表达式 - 收集一些在平时项目开发中经常用到的正则表达式</a></p>
</li>
</ol>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/07/31/paxos-essence-and-demo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/31/paxos-essence-and-demo/" class="post-title-link" itemprop="url">paxos精髓及示例</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-31 18:58:42" itemprop="dateCreated datePublished" datetime="2019-07-31T18:58:42+08:00">2019-07-31</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-01 18:21:04" itemprop="dateModified" datetime="2019-08-01T18:21:04+08:00">2019-08-01</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/分布式一致性/" itemprop="url" rel="index"><span itemprop="name">分布式一致性</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/分布式一致性/paxos算法/" itemprop="url" rel="index"><span itemprop="name">paxos算法</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">14k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">13 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Paxos精髓"><a href="#Paxos精髓" class="headerlink" title="Paxos精髓"></a>Paxos精髓</h2><p>paxos协议用来解决的问题可以用一句话来简化: </p>
<blockquote>
<p>proposer将发起提案（value）给所有accpetor，超过半数accpetor获得批准后，proposer将提案写入accpetor内，最终所有accpetor获得一致性的确定性取值，且后续不允许再修改。</p>
</blockquote>
<p>协议分为两大阶段，每个阶段又分为a/b两小步骤：</p>
<h3 id="准备阶段（占坑阶段）"><a href="#准备阶段（占坑阶段）" class="headerlink" title="准备阶段（占坑阶段）"></a>准备阶段（占坑阶段）</h3><h4 id="Phase-1a-Prepare"><a href="#Phase-1a-Prepare" class="headerlink" title="Phase 1a: Prepare"></a>Phase 1a: <em>Prepare</em></h4><p>Proposer选择一个提议编号n，向所有的Acceptor广播Prepare（n）请求。</p>
<h4 id="Phase-1b-Promise"><a href="#Phase-1b-Promise" class="headerlink" title="Phase 1b: Promise"></a>Phase 1b: <em>Promise</em></h4><p>Acceptor接收到Prepare（n）请求，若提议编号n比之前接收的Prepare请求都要大，则承诺将不会接收提议编号比n小的提议，并且带上之前Accept的提议中编号小于n的最大的提议，否则不予理会。</p>
<h3 id="接受阶段（提交阶段）"><a href="#接受阶段（提交阶段）" class="headerlink" title="接受阶段（提交阶段）"></a>接受阶段（提交阶段）</h3><h4 id="Phase-2a-Accept"><a href="#Phase-2a-Accept" class="headerlink" title="Phase 2a: Accept"></a>Phase 2a: <em>Accept</em></h4><p>​    1. 如果未超过半数accpetor响应，直接转为提议失败；</p>
<p>​    2. 如果超过多数Acceptor的承诺，又分为不同情况：</p>
<p>​            2.1 如果所有Acceptor都未接收过值（都为null），那么向所有的Acceptor发起自己的值和提议编号n，记住，一定是所有Acceptor都没接受过值；</p>
<p>​            2.2 如果有部分Acceptor接收过值，那么从所有接受过的值中选择对应的提议编号最大的作为提议的值，提议编号仍然为n。但此时Proposer就不能提议自己的值，只能信任Acceptor通过的值，维护一但获得确定性取值就不能更改原则；</p>
<h4 id="Phase-2b-Accepted"><a href="#Phase-2b-Accepted" class="headerlink" title="Phase 2b: Accepted"></a>Phase 2b: <em>Accepted</em></h4><p>Acceptor接收到提议后，如果该提议版本号不等于自身保存记录的版本号（第一阶段记录的），不接受该请求，相等则写入本地。</p>
<p>整个paxos协议过程看似复杂难懂，但只要把握和理解这两点就基本理解了paxos的精髓：</p>
<ol>
<li><p>理解第一阶段accpetor的处理流程：如果本地已经写入了，不再接受和同意后面的所有请求，并返回本地写入的值；如果本地未写入，则本地记录该请求的版本号，并不再接受其他版本号的请求，简单来说只信任最后一次提交的版本号的请求，使其他版本号写入失效；</p>
</li>
<li><p>理解第二阶段proposer的处理流程：未超过半数accpetor响应，提议失败；超过半数的accpetor值都为空才提交自身要写入的值，否则选择非空值里版本号最大的值提交，最大的区别在于是提交的值是自身的还是使用以前提交的。</p>
</li>
</ol>
<h3 id="Basic-Paxos信息流协议过程举例"><a href="#Basic-Paxos信息流协议过程举例" class="headerlink" title="Basic Paxos信息流协议过程举例"></a>Basic Paxos信息流协议过程举例</h3><p>看这个最简单的例子：1个processor，3个Acceptor，无learner。</p>
<p>目标：proposer向3个aceptort 将name变量写为v1。</p>
<p>第一阶段A：proposer发起prepare（name，n1）,n1是递增提议版本号，发送给3个Acceptor，说，我现在要写name这个变量，我的版本号是n1<br>第一阶段B：Acceptor收到proposer的消息，比对自己内部保存的内容，发现之前name变量（null，null）没有被写入且未收到过提议，都返回给proposer，并在内部记录name这个变量，已经有proposer申请提议了，提议版本号是n1;<br>第二阶段A：proposer收到3个Acceptor的响应，响应内容都是：name变量现在还没有写入，你可以来写。proposer确认获得超过半数以上Acceptor同意，发起第二阶段写入操作：accept（v1,n1），告诉Acceptor我现在要把name变量协议v1,我的版本号是刚刚获得通过的n1;<br>第二阶段B：accpetor收到accept（v1,n1），比对自身的版本号是一致的，保存成功，并响应accepted（v1,n1）；<br>结果阶段：proposer收到3个accepted响应都成功，超过半数响应成功，到此name变量被确定为v1。</p>
<p>以上是正常的paxos协议提议确定流程，是不是很简单，很容易理解呢？</p>
<p>确定你理解了上面的例子再往后看。</p>
<p>这是最简单也最容易理解的例子，但真实情况远比这个复杂，还有以下问题：</p>
<p>如果其中的某个Acceptor没响应怎么处理？<br>如果只写成功了一个accpetor又怎么处理，写成功两个呢？<br>如果多个proposer并发写会导致accpetor写成不同值吗？<br>learner角色是做什么用？<br>为什么是超过半数同意？</p>
<h4 id="paxos特殊情况下的处理"><a href="#paxos特殊情况下的处理" class="headerlink" title="paxos特殊情况下的处理"></a>paxos特殊情况下的处理</h4><p><strong>第一种情况：Proposer提议正常，未超过accpetor失败情况</strong></p>
<p>问题：还是上面的例子，如果第二阶段B，只有2个accpetor响应接收提议成功，另外1个没有响应怎么处理呢？</p>
<p>处理：proposer发现只有2个成功，已经超过半数，那么还是认为提议成功，并把消息传递给learner，由learner角色将确定的提议通知给所有accpetor，最终使最后未响应的accpetor也同步更新，通过learner角色使所有Acceptor达到最终一致性。</p>
<p><strong>第二种情况：Proposer提议正常，但超过accpetor失败情况</strong></p>
<p>问题：假设有2个accpetor失败，又该如何处理呢？</p>
<p>处理：由于未达到超过半数同意条件，proposer要么直接提示失败，要么递增版本号重新发起提议，如果重新发起提议对于第一次写入成功的accpetor不会修改，另外两个accpetor会重新接受提议，达到最终成功。</p>
<p><strong>情况再复杂一点：还是一样有3个accpetor，但有两个proposer。</strong></p>
<p><strong>情况一：proposer1和proposer2串行执行</strong></p>
<p>proposer1和最开始情况一样，把name设置为v1，并接受提议。</p>
<p>proposer1提议结束后，proposer2发起提议流程：</p>
<p>第一阶段A：proposer1发起prepare（name，n2）</p>
<p>第一阶段B：Acceptor收到proposer的消息，发现内部name已经写入确定了，返回（name,v1,n1）</p>
<p>第二阶段A：proposer收到3个Acceptor的响应，发现超过半数都是v1，说明name已经确定为v1，接受这个值，不再发起提议操作。</p>
<p><strong>情况二：proposer1和proposer2交错执行</strong></p>
<p>proposer1提议accpetor1成功，但写入accpetor2和accpetor3时，发现版本号已经小于accpetor内部记录的版本号（保存了proposer2的版本号），直接返回失败。</p>
<p>proposer2写入accpetor2和accpetor3成功，写入accpetor1失败，但最终还是超过半数写入v2成功，name变量最终确定为v2；</p>
<p>proposer1递增版本号再重试发现超过半数为v2，接受name变量为v2，也不再写入v1。name最终确定还是为v2</p>
<p><strong>情况三：proposer1和proposer2第一次都只写成功1个Acceptor怎么办</strong></p>
<p>都只写成功一个，未超过半数，那么Proposer会递增版本号重新发起提议，这里需要分多种情况：</p>
<ol>
<li>3个Acceptor都响应提议，发现Acceptor1{v1,n1} ,Acceptor2{v2,n2},Acceptor{null,null}，Processor选择最大的{v2,n2}发起第二阶段，成功后name值为v2;</li>
<li>2个Acceptor都响应提议，<ul>
<li>如果是Acceptor1{v1,n1} ,Acceptor2{v2,n2}，那么选择最大的{v2,n2}发起第二阶段，成功后name值为v2;</li>
<li>如果是Acceptor1{v1,n1} ,Acceptor3{null,null}，那么选择最大的{v1,n1}发起第二阶段，成功后name值为v1;</li>
<li>如果是Acceptor2{v2,n2} ,Acceptor3{null,null}，那么选择最大的{v2,n2}发起第二阶段，成功后name值为v2;</li>
</ul>
</li>
<li>只有1个Acceptor响应提议，未达到半数，放弃或者递增版本号重新发起提议<br><strong>可以看到，都未达到半数时，最终值是不确定的！</strong></li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li>paxos算法wiki: <a href="https://en.wikipedia.org/wiki/Paxos_(computer_science)#Basic_Paxos" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Paxos_(computer_science)#Basic_Paxos</a></li>
<li>首先，推荐的是知行学社的《分布式系统与Paxos算法视频课程》： 视频讲的非常好，很适合入门，循序渐进慢慢推导，我自己看了不下5遍，视频讲解理解更深，推荐大家都看看。</li>
<li>推荐刘杰的《分布式系统原理介绍》 ，里面有关于paxos的详细介绍，例子非常多，也有包括paxos协议的证明过程，大而全，质量相当高的一份学习资料！</li>
<li>推荐的一份高质量ppt《可靠分布式系统基础 Paxos 的直观解释》: <a href="https://drmingdrmer.github.io/tech/distributed/2015/11/11/paxos-slide.html；" target="_blank" rel="noopener">https://drmingdrmer.github.io/tech/distributed/2015/11/11/paxos-slide.html；</a></li>
<li>技术类的东西怎么能只停留在看上面，肯定要看代码啊，推荐微信开源的phxpaxos：<a href="https://github.com/tencent-wechat/phxpaxos，结合代码对协议理解更深。" target="_blank" rel="noopener">https://github.com/tencent-wechat/phxpaxos，结合代码对协议理解更深。</a></li>
<li><a href="http://research.google.com/archive/paxos_made_live.html" target="_blank" rel="noopener">《Paxos Made live》</a>。这篇论文是 Google 发表的，讨论了 paxos 的工程实践，也就是 chubby 这个众所周知的分布式服务的实现，可以结合<a href="https://research.google.com/archive/chubby.html" target="_blank" rel="noopener">《The Chubby lock service for loosely-coupled distributed systems》</a> 一起看。实际应用中的难点，比如 master 租约实现、group membership 变化、Snapshot 加快复制和恢复以及实际应用中遇到的故障、测试等问题，特别是最后的测试部分。非常值得一读。<a href="https://research.google.com/archive/chubby.html" target="_blank" rel="noopener">《The Chubby lock service for loosely-coupled distributed systems》</a> 更多介绍了 Chubby 服务本身的设计决策，为什么是分布式锁服务，为什么是粗粒度的锁，为什么是目录文件模式，事件通知、多机房部署以及应用碰到的使用问题等等。</li>
<li>Paxos 我还着重推荐阅读微信后端团队写的<a href="https://zhuanlan.zhihu.com/p/21438357?refer=lynncui" target="_blank" rel="noopener">系列博客</a>，包括他们开源的 <a href="https://github.com/tencent-wechat/phxpaxos/" target="_blank" rel="noopener">phxpaxos</a> 实现，基本上将所有问题都讨论到了，并且通俗易懂。</li>
<li>一致性方面另一块就是 Raft 算法，按照 Google Chubby 论文里的说法，</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`Indeed, all working protocols for asynchronous consensus we have so far  encountered have Paxos at their core.`</span><br></pre></td></tr></table></figure>

<p>但是 Raft 真的好理解多了，我读的是<a href="https://docs.google.com/viewer?url=https%3A%2F%2Fraft.github.io%2Fraft.pdf" target="_blank" rel="noopener">《In Search of an Understandable Consensus Algorithm》</a>，论文写到这么详细的步骤，你不想理解都难。毕竟 Raft 号称就是一个 Understandable Consensus Algorithm。无论从任何角度，都推荐阅读这一篇论文。</p>
<p>首先能理解 paxos 的一些难点，其次是了解 Raft 的实现，加深对 Etcd 等系统的理解。这篇论文还有一个 250 多页的加强版<a href="https://ramcloud.stanford.edu/~ongaro/thesis.pdf" target="_blank" rel="noopener">《CONSENSUS: BRIDGING THEORY AND PRACTICE》</a>，教你一行一行写出一个 Raft 实现，我还没有学习，有兴趣可以自行了解。Raft 通过明确引入 leader（其实 multi paxos 引申出来也有，但是没有这么明确的表述）来负责 client 交互和日志复制，将整个算法过程非常清晰地表达出来。Raft 的算法正确性的核心在于保证 Leader Completeness ，选举算法选出来的 leader 一定是包含了所有 committed entries 的，这是因为所有 committed entries 一定会在多数派至少一个成员里存在，所以设计的选举算法一定能选出来这么一个成员作为 leader。多数派 accept 应该说是一致性算法正确性的最重要的保证。</p>
<p>最后，我还读了<a href="https://syslab.cs.washington.edu/papers/tapir-tr14.pdf" target="_blank" rel="noopener">《Building Consistent Transactions with Inconsistent Replication》</a>，包括作者的<a href="https://www.youtube.com/watch?v=yE3eMxYJDiE" target="_blank" rel="noopener">演讲</a>，作者也开放了<a href="https://github.com/UWSysLab/tapir" target="_blank" rel="noopener">源码</a>。Google Spanner 基本是将 paxos 算法应用到了极致，但是毕竟不是所有公司都是这么财大气粗搞得起 TrueTime API，架得起全球机房，控制或者承受得了事务延时。这篇论文提出了另一个思路，论文介绍的算法分为两个层次： IR 和基于其他上的 TAPIR。前者就是 Inconsistent Replication，它将操作分为两类：</p>
<ul>
<li><p>inconsistent： 可以任意顺序执行，成功执行的操作将持久化，支持 failover。</p>
</li>
<li><p>consensus：同样可以任意顺序执行并持久化 failover，但是会返回一个唯一的一致(consensus)结果。</p>
</li>
</ul>
<hr>
<h2 id="Java简单实现Basic-Paxos算法"><a href="#Java简单实现Basic-Paxos算法" class="headerlink" title="Java简单实现Basic Paxos算法"></a>Java简单实现Basic Paxos算法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Alipay.com Inc.</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2004-2019 All Rights Reserved.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> paxos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Charsets;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.HashFunction;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.Hashing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xbyan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> $Id: PaxosStudy.java, v 0.1 2019-07-01 5:47 PM xbyan Exp $$</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaxosStudy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashFunction HASH_FUNCTION = Hashing.murmur3_32();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random       RAMDOM        = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[]     PROPOSALS     = &#123; <span class="string">"ProjectA"</span>, <span class="string">"ProjectB"</span>, <span class="string">"ProjectC"</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//新建server组</span></span><br><span class="line">        List&lt;Acceptor&gt; acceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Arrays.asList(<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>, <span class="string">"E"</span>).forEach(name -&gt; acceptors.add(<span class="keyword">new</span> Acceptor(name)));</span><br><span class="line">        <span class="comment">//开始投票</span></span><br><span class="line">        Proposer.vote(<span class="keyword">new</span> Proposal(<span class="number">1L</span>, <span class="keyword">null</span>), acceptors);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">(String subject, String operation,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String result)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(subject + <span class="string">":"</span> + operation + <span class="string">"&lt;"</span> + result + <span class="string">"&gt;"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对于提案的约束，第三方约束要求</span></span><br><span class="line"><span class="comment">     * 如果maxVote不存在，那么没有限制，下一次表决可以使用任意提案</span></span><br><span class="line"><span class="comment">     * 否则，下一次表决要沿用maxVote提案</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentVoteNumber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> proposals</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Proposal <span class="title">nextProposal</span><span class="params">(<span class="keyword">long</span> currentVoteNumber, List&lt;Proposal&gt; proposals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> voteNumber = currentVoteNumber + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//刚开始投票</span></span><br><span class="line">        <span class="keyword">if</span> (proposals.isEmpty()) &#123;</span><br><span class="line">            Proposal proposal = <span class="keyword">new</span> Proposal(voteNumber,</span><br><span class="line">                PROPOSALS[RAMDOM.nextInt(PROPOSALS.length)]);</span><br><span class="line">            System.out.println(<span class="string">"NEXT PROPOSER(刚开始投票), currentVoteNumber"</span> + currentVoteNumber</span><br><span class="line">                               + <span class="string">",proposal="</span> + proposal);</span><br><span class="line">            <span class="keyword">return</span> proposal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//为之前的票排序</span></span><br><span class="line">        Collections.sort(proposals);</span><br><span class="line">        Proposal maxVote = proposals.get(proposals.size() - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//列表里最大值</span></span><br><span class="line">        <span class="keyword">long</span> maxVoteNumber = maxVote.getVoteNumber();</span><br><span class="line">        String content = maxVote.getContent();</span><br><span class="line">        <span class="keyword">if</span> (maxVoteNumber &gt;= currentVoteNumber) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"illegal state maxVoteNumber"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (content != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Proposal proposal = <span class="keyword">new</span> Proposal(voteNumber, content);</span><br><span class="line">            System.out.println(<span class="string">"NEXT PROPOSER(content不为空), voteNumber="</span> + voteNumber + <span class="string">",proposal="</span></span><br><span class="line">                               + proposal + <span class="string">",maxVote="</span> + maxVote);</span><br><span class="line">            <span class="keyword">return</span> proposal;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Proposal proposal = <span class="keyword">new</span> Proposal(voteNumber,</span><br><span class="line">                PROPOSALS[RAMDOM.nextInt(PROPOSALS.length)]);</span><br><span class="line">            System.out.println(<span class="string">"NEXT PROPOSER(content为空), voteNumber="</span> + voteNumber + <span class="string">",proposal="</span></span><br><span class="line">                               + proposal + <span class="string">",maxVote="</span> + maxVote);</span><br><span class="line">            <span class="keyword">return</span> proposal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proposer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> proposal</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> acceptors</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(Proposal proposal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Collection&lt;Acceptor&gt; acceptors)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            <span class="comment">//法定人数 n/2+1</span></span><br><span class="line">            <span class="keyword">int</span> quorum = Math.floorDiv(acceptors.size(), <span class="number">2</span>) + <span class="number">1</span>;</span><br><span class="line">            System.out.println(<span class="string">"quorum  "</span> + quorum);</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">//开始投票</span></span><br><span class="line">                printInfo(<span class="string">"VOTE_ROUND"</span>, <span class="string">"START"</span>, ++count + <span class="string">"：开始向acceptor发送信息"</span>);</span><br><span class="line">                List&lt;Proposal&gt; proposals = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Acceptor acceptor : acceptors) &#123;</span><br><span class="line">                    Promise promise = acceptor.onPrepare(proposal);</span><br><span class="line">                    <span class="keyword">if</span> (promise != <span class="keyword">null</span> &amp;&amp; promise.isAck()) &#123;</span><br><span class="line">                        <span class="comment">//Acceptor批准后就可以将发起者加入发起者列表里</span></span><br><span class="line">                        System.out</span><br><span class="line">                            .println(<span class="string">"--------------------------------------------------ACCEPTOR批准,将发起者加入队列里,proposal="</span> + promise.getProposal());</span><br><span class="line">                        proposals.add(promise.getProposal());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (proposals.size() &lt; quorum) &#123;</span><br><span class="line">                    <span class="comment">//小于法定人数</span></span><br><span class="line">                    printInfo(<span class="string">"PROPOSER["</span> + proposal + <span class="string">"]"</span>, <span class="string">"VOTE"</span>,</span><br><span class="line">                        <span class="string">"NOT PREPARED：接收到消息的acceptor小于半数"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"onPrepare阶段编号增加 重新发起投票"</span>);</span><br><span class="line">                    proposal = nextProposal(proposal.getVoteNumber(), proposals);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"接收到消息的acceptor大于半数，开始提案内容"</span>);</span><br><span class="line">                <span class="keyword">int</span> acceptCount = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (Acceptor acceptor1 : acceptors) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (acceptor1.onAccept(proposal))</span><br><span class="line">                        acceptCount++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (acceptCount &lt; quorum) &#123;</span><br><span class="line">                    printInfo(<span class="string">"PROPOSER["</span> + proposal + <span class="string">"]"</span>, <span class="string">"VOTE"</span>, <span class="string">"NOT ACCEPTED,接受提案的少于半数"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"onAccept阶段编号增加 重新发起投票"</span>);</span><br><span class="line">                    proposal = nextProposal(proposal.getVoteNumber(), proposals);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            printInfo(<span class="string">"PROPOSER["</span> + proposal + <span class="string">"]"</span>, <span class="string">"VOTE"</span>, <span class="string">"SUCCESS，接受提案成功"</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> </span>&#123;</span><br><span class="line">        <span class="comment">//上次表决结果</span></span><br><span class="line">        <span class="keyword">private</span> Proposal last = <span class="keyword">new</span> Proposal();</span><br><span class="line">        <span class="keyword">private</span> String   name;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Acceptor</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Promise <span class="title">onPrepare</span><span class="params">(Proposal proposal)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            <span class="comment">//假设这个过程有50%的几率失败</span></span><br><span class="line">            <span class="keyword">if</span> (Math.random() - <span class="number">0.5</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                printInfo(<span class="string">"ACCEPTER_"</span> + name, <span class="string">"PREPARE"</span>, <span class="string">"NO RESPONSE 向"</span> + name + <span class="string">" 发送失败"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (proposal == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null proposal"</span>);</span><br><span class="line">            <span class="comment">//大于</span></span><br><span class="line">            <span class="keyword">if</span> (proposal.getVoteNumber() &gt; last.getVoteNumber()) &#123;</span><br><span class="line">                Promise response = <span class="keyword">new</span> Promise(<span class="keyword">true</span>, last);</span><br><span class="line">                last = proposal;</span><br><span class="line">                printInfo(<span class="string">"ACCEPTER_"</span> + name, <span class="string">"PREPARE"</span>, <span class="string">"OK "</span> + name + <span class="string">" 记下编号，返回信息,last="</span> + last);</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                printInfo(<span class="string">"ACCEPTER_"</span> + name, <span class="string">"PREPARE"</span>, <span class="string">"REJECTED "</span> + name + <span class="string">" 已保存有选定的编号，拒绝"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Promise(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onAccept</span><span class="params">(Proposal proposal)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            <span class="comment">//假设这个过程有50%的几率失败</span></span><br><span class="line">            <span class="keyword">if</span> (Math.random() - <span class="number">0.5</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                printInfo(<span class="string">"ACCEPTER_"</span> + name, <span class="string">"ACCEPT"</span>, <span class="string">"NO RESPONSE "</span> + name + <span class="string">" 发送提案失败"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> accepted = last.equals(proposal);</span><br><span class="line">            printInfo(<span class="string">"ACCEPTER_"</span> + name, <span class="string">"ACCEPT"</span>,</span><br><span class="line">                name + (accepted ? <span class="string">"OK：通过"</span> : <span class="string">"NO: 不通过"</span>) + <span class="string">"last="</span> + last + <span class="string">",proposal="</span> + proposal);</span><br><span class="line">            <span class="keyword">return</span> accepted;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Promise</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span>  ack;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Proposal proposal;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Promise</span><span class="params">(<span class="keyword">boolean</span> ack, Proposal proposal)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.ack = ack;</span><br><span class="line">            <span class="keyword">this</span>.proposal = proposal;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ack;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Proposal <span class="title">getProposal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> proposal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proposal</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Proposal</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span>   voteNumber;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String content;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proposal</span><span class="params">(<span class="keyword">long</span> voteNumber, String content)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.voteNumber = voteNumber;</span><br><span class="line">            <span class="keyword">this</span>.content = content;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proposal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>(<span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getVoteNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> voteNumber;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> content;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Proposal o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Long.compare(voteNumber, o.voteNumber);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Proposal))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            Proposal proposal = (Proposal) obj;</span><br><span class="line">            <span class="keyword">return</span> voteNumber == proposal.voteNumber</span><br><span class="line">                   &amp;&amp; StringUtils.equals(content, proposal.content);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> HASH_FUNCTION.newHasher().putLong(voteNumber).putString(content, Charsets.UTF_8)</span><br><span class="line">                .hash().asInt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder().append(voteNumber).append(<span class="string">':'</span>).append(content).toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.sainpo.top/2019/07/29/paxos-by-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sainpo.yxb">
      <meta itemprop="description" content="码农|理工男|文青">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="窦小固的小木屋">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/29/paxos-by-example/" class="post-title-link" itemprop="url">paxos-by-example</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-29 20:31:28" itemprop="dateCreated datePublished" datetime="2019-07-29T20:31:28+08:00">2019-07-29</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-31 18:37:08" itemprop="dateModified" datetime="2019-07-31T18:37:08+08:00">2019-07-31</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/分布式一致性/" itemprop="url" rel="index"><span itemprop="name">分布式一致性</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/分布式一致性/paxos算法/" itemprop="url" rel="index"><span itemprop="name">paxos算法</span></a></span>

                
                
              
            </span>
          

          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">6.1k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">6 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>Paxos算法在分布式领域具有非常重要的地位。但是Paxos算法有两个比较明显的缺点：1.难以理解 2.工程实现更难。</p>
<p>网上有很多讲解Paxos算法的文章，但是质量参差不齐。看了很多关于Paxos的资料后发现，学习Paxos最好的资料是论文<a href="https://www.cnblogs.com/YaoDD/p/6150498.html" target="_blank" rel="noopener">Paxos Made Simple</a>，其次是中、英文版维基百科对Paxos的介绍。本文试图带大家一步步揭开Paxos神秘的面纱。</p>
<h2 id="Paxos是什么"><a href="#Paxos是什么" class="headerlink" title="Paxos是什么"></a>Paxos是什么</h2><blockquote>
<p>Paxos算法是基于<strong>消息传递</strong>且具有<strong>高度容错特性</strong>的<strong>一致性算法</strong>，是目前公认的解决<strong>分布式一致性</strong>问题<strong>最有效</strong>的算法之一。</p>
</blockquote>
<p>Google Chubby的作者Mike Burrows说过这个世界上<strong>只有一种</strong>一致性算法，那就是Paxos，其它的算法都是<strong>残次品</strong>。</p>
<p>虽然Mike Burrows说得有点夸张，但是至少说明了Paxos算法的地位。然而，Paxos算法也因为晦涩难懂而臭名昭著。本文的目的就是带领大家深入浅出理解Paxos算法，不仅理解它的执行流程，还要理解算法的推导过程，作者是怎么一步步想到最终的方案的。只有理解了推导过程，才能深刻掌握该算法的精髓。而且理解推导过程对于我们的思维也是非常有帮助的，可能会给我们带来一些解决问题的思路，对我们有所启发。</p>
<p>最近在看paxos算法, 看了不少博客, 都感觉总结得不够到位,甚至有理解偏差的地方,倒是在博客的引用文章里面找到了一篇英文文献,看完后豁然开朗茅塞顿开.</p>
<p>于是把那篇英文原文翻译了一下, 加深一下理解</p>
<p>英文文献虽是2012年的了, 但是短小精悍,值得一看,原文地址是:</p>
<blockquote>
<p><a href="https://angus.nyc/2012/paxos-by-example/" target="_blank" rel="noopener">angus.nyc/2012/paxos-by-example/ </a></p>
</blockquote>
<p>文章中不全是直译, 有些地方改成了我自己的理解, 所以有可能有理解错的地方, 还望指出.</p>
<h2 id="关于作者-Lamport"><a href="#关于作者-Lamport" class="headerlink" title="关于作者: Lamport"></a>关于作者: Lamport</h2><p>提到Paxos算法，我们不得不首先来介绍下Paxos算法的作者Leslie Lamport(莱斯利·兰伯特, <a href="http://www.lamport.org" target="_blank" rel="noopener">http://www.lamport.org</a> )及其对计算机科学尤其是分布式计算领域的杰出贡献。作为2013年的新科图灵奖得主，Lamport是计算机科学领域一位拥有杰出成就的传奇人物，其先后多次荣获ACM和IEEE以及其他各类计算机重大奖项。Lamport对时间时钟、面包店算法、拜占庭将军问题以及Paxos算法的创造性研究，极大地推动了计算机科学尤其是分布式计算的发展，全世界无数工程师得益于他的理论，其中Paxos算法的提出，正是Lamport多年的研究成果。</p>
<p>说起Paxos理论的发表，还有一段非常有趣的历史故事。Lamport早在1990年就已经将其对Paxos算法的研究论文<a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/lamport-paxos.pdf" target="_blank" rel="noopener">《<strong>The PartTime Parliament</strong>》</a>提交给ACM TOCS Jnl.的评审委员会了，但是由于Lamport“创造性”地使用了故事的方式来进行算法的描述，导致当时委员会的工作人员没有一个能够正确地理解他对算法的描述，时任主编要求Lamport使用严谨的数据证明方式来描述该算法，否则他们将不考虑接受这篇论文。遗憾的是，Lamport并没有接收他们的建议，当然也就拒绝了对论文的修改，并撤销了对这篇论文的提交。在后来的一个会议上，Lamport还对此事耿耿于怀：“为什么这些搞理论的人一点幽默感也没有呢？”</p>
<p>幸运的是，还是有人能够理解Lamport那公认的令人晦涩的算法描述的。1996年，来自微软的Butler Lampson在WDAG96上提出了重新审视这篇分布式论文的建议，在次年的WDAG97上，麻省理工学院的Nancy Lynch也公布了其根据Lamport的原文重新修改后的<a href="http://research.microsoft.com/en-us/um/people/blampson/60-PaxosAlgorithm/Acrobat.pdf" target="_blank" rel="noopener">《<strong>Revisiting the Paxos Algorithm</strong>》</a>，“帮助”Lamport用数学的形式化术语定义并证明了Paxos算法。于是在1998年的ACM TOCS上，这篇延迟了9年的论文终于被接受了，也标志着Paxos算法正式被计算机科学接受并开始影响更多的工程师解决分布式一致性问题。</p>
<p>后来在2001年，Lamport本人也做出了让步，这次他放弃了故事的描述方式，而是使用了通俗易懂的语言重新讲述了原文，并发表了<a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/paxos-simple.pdf" target="_blank" rel="noopener">《<strong>Paxos Made Simple</strong>》</a>——当然，Lamport甚为固执地认为他自己的表述语言没有歧义，并且也足够让人明白Paxos算法，因此不需要数学来协助描述，于是整篇文章还是没有任何数学符号。好在这篇文章已经能够被更多的人理解，相信绝大多数的Paxos爱好者也都是从这篇文章开始慢慢进入了Paxos的神秘世界。</p>
<p>由于Lamport个人自负固执的性格，使得Paxos理论的诞生可谓一波三折。关于Paxos理论的诞生过程，后来也成为了计算机科学领域被广泛流传的学术趣事。</p>
<p><img src="/2019/07/29/paxos-by-example/Lamport.png" alt="Lamport本尊"></p>
<blockquote>
<p>图0: Lamport本尊</p>
</blockquote>
<h2 id="译文开始"><a href="#译文开始" class="headerlink" title="译文开始"></a>译文开始</h2><p>本文通过一个实例描述了一个叫Paxos的分布式一致性算法</p>
<p>分布式一致性算法通常是用于让多个计算机节点就某个单值的修改达成一致, 例如事务的提交commit或回滚rollback, 典型的思想就是二阶段提交或三阶段提交.</p>
<p>算法并不关心这个单值是什么,只关心最后只有唯一一个值被所有的节点选中, 对该值的修改达成一致</p>
<p>在一个分布式系统中这非常的难, 因为不同机器之前的消息可能会丢失, 或是被无限延迟, 甚至机器本身也会挂掉</p>
<p>Paxos算法可以保证最终只会有一个值会被选中, 但是不能保证如果集群中的大多数节点挂掉后,还能选中一个值</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Paxos的节点可以是proposer, acceptor,learner中的任何一种角色.proposer会提议一个它想被采纳的值, 一般是通过发送一个包含该提议值的提案给集群中的每个acceptor.  然后acceptor会独立的决定是否接受这个提案–它可能会接收到多个proposer的不同提案, 决定好后会把它的决定发给learner.  learner的作用是判断一个值是否已经被接受.在Paxos算法中, 只有一个值被大多数的acceptor选中, 才算被Paxos算法选中.在实际项目中, 一个节点可能担任多种角色, 但是在这个例子里面, 每一种角色都是一个独立的节点.</p>
<p><img src="/2019/07/29/paxos-by-example/Figure1-BasicPaxos.png" alt="Paxos的基本架构"></p>
<blockquote>
<p>图1 Paxos的基本架构. 几个proposer向acceptor提交提案. 当一个acceptor接受了一个值后, 它把它的决定发给learner</p>
</blockquote>
<h3 id="Paxos算法例子"><a href="#Paxos算法例子" class="headerlink" title="Paxos算法例子"></a>Paxos算法例子</h3><p>在标准的Paxos算法中, 一个proposer会发送两种类型的消息给acceptors: prepare request 和accept request. 在算法的第一阶段, proposer会发送一个prepare request给每一个acceptor, 这个prepare request包含一个提议值value和一个提案号number.每一个proposer的提案号number必须是正数, 单调递增的,独一无二的自然数<sup><a href="#fn1">[1]</a></sup>.</p>
<p>在下面图2的例子中, 有两个proposer, 都在发送prepare request. proposer A的请求([n=2,v=8])比proposer B的请求([n=4,v=5])先到达acceptor X和acceptor Y, 而proposer B的请求先到达acceptor Z</p>
<p><img src="/2019/07/29/paxos-by-example/Figure2-Paxos.png" alt="Paxos 2"></p>
<blockquote>
<p>图2: Paxos. proposer A和B各发送了一个prepare request 给每一个accetor. 在这个例子中, proposer A的请求先到达acceptor X和Y, 而proposer B的请求先到达了acceptor Z.</p>
</blockquote>
<p>如果一个acceptor接收到了一个prepare request而又没接收过其他的提案, 这个acceptor会回应一个prepare response, 并保证不会接受其他比当前提案号number更小的提案. 下面图3展示了每个acceptor是如何响应它们接收到的prepare request的</p>
<p><img src="/2019/07/29/paxos-by-example/Figure3-Paxos.png" alt="Paxos 3"></p>
<blockquote>
<p>图3: 每个acceptor都对它接收到的第一个prepare request 进行prepare response.</p>
</blockquote>
<p>最终, acceptor Z接收到了proposer A的请求<sup><a href="#fn2">[2]</a></sup>, acceptor X和Y收到了proposer B的请求.</p>
<p>如果一个acceptor之前已经接收了一个提案号更高的prepare request的话, 那么后面收到的prepare request就会被忽略, 这个例子中就是acceptor Z会忽略掉proposer A的请求(Z已经接收了B的提案n=4).</p>
<p>如果acceptor之前没有接收过更高提案号的提案, 它会保证忽略其他提案号比这个更低的请求(注意是包括prepare request和accept request),然后在prepare response中把它已经选中的提案号最高的提议(包括这个提议的值)发送给proposer.在这个例子就是acceptor X和Y给proposer B的响应(X和Y已经接受了一个B的[n=2,v=8]的提案,当再收到[n=4, v=5]的提案时, 它保证会忽略任何n&lt;4的prepare request和accept request, 然后把[n=2, v=8]的prepare response回去给B)</p>
<p><img src="/2019/07/29/paxos-by-example/Figure4-Paxos.png" alt="Paxos 4"></p>
<blockquote>
<p>图4: acceptor Z 忽略了proposer A的请求, 因为它已经接收到了更高的提议号(4 &gt; 2). acceptor X和Y给proposer B响应了它见过最高的提议号的提案, 并承诺会忽略提案号更小的提案</p>
</blockquote>
<p>一旦proposer 收到了大多数acceptor的prepare response, 它就可以开始给所有的acceptor发送accept request了. 因为proposer A接收到prepare response中表明在它之前没有更早的提案. 所以它的accept request中的提案号和提议值都是跟prepare request中的一样.然而,这个accept request被所有的acceptor都拒绝了,因为它们都承诺了不会接收提议号比4更新的提案(因为都见过proposer B的提案了)</p>
<p>Proposer B的accept request情况就跟proposer A的有所不同了. 首先它的提案号还是它之前的提案号(n=4), 但是提议值却不是它之前的提议值了(它之前提议的是v=5), 而是它在prepare response中接收到的提议值(v=8)<sup><a href="#fn3">[3]</a></sup></p>
<p><img src="/2019/07/29/paxos-by-example/Figure5-Paxos.png" alt="Paxos 5"></p>
<blockquote>
<p>图5: proposer B也发送了一个accept request给每一个acceptor.acceptor request中的提案号是它之前的提案号(4), 而提议值是它在prepare response中收到的值(8, 来自proposer A的提案[n=2, v=8])</p>
</blockquote>
<p>如果acceptor收到了一个提案号不小于它见过的accept request, 它会接受这个accept request并且发送一个通知给到learner节点. 当learner节点发现大多数acceptor都已经接受了一个值的时候,Paxos算法就认为这个值已经被选中.</p>
<p><img src="/2019/07/29/paxos-by-example/Figure6-OnceAvalueHas.png" alt="Paxos 6"></p>
<p>当一个值被paxos选中后,后续的流程中将不能改变这个值.例如,当另一个proposer C发送一个提案号更高的prepare request(例如, [n=6, v=7])过来时,所有的acceptor都会响应它之前已经选中的提议(n=4,v=8).这会要求proposer C在后续的acceptor request中也只能发送[n=6, v=8]的提议, 即只能确认一遍已经选中的这个值. 再后面, 如果有少量的acceptor还没选中一个值的话, 这个流程会保证最终所有的节点都会一致地选中同一个值.</p>
<h2 id="译文结束"><a href="#译文结束" class="headerlink" title="译文结束"></a>译文结束</h2><hr>
<ol>
<li>提案号的唯一性的保证不是Paxos算法的内容 <a href="#fnref1">↩︎</a></li>
<li>这个也可能不会发送, 但是这个算法中也是有可能的 <a href="#fnref2">↩︎</a></li>
<li>注意这个是它从prepare response中收到的最高的提案号. 在这个例子中, proposer B的提案号(n=4)是比proposer A的提案号(n=2)大. 但是在它的prepare request的响应中, 它只收到了proposer A的提议([n=2, v=8]). 如果它在prepare response中没有收到其他的提案的话, 它就会发送自己的提案([n=4,v=5]) <a href="#fnref3">↩︎</a></li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><p>NEAT ALGORITHMS - PAXOS(小动画可以辅助读懂): <a href="http://harry.me/blog/2014/12/27/neat-algorithms-paxos/" target="_blank" rel="noopener">http://harry.me/blog/2014/12/27/neat-algorithms-paxos/</a></p>
</li>
<li><p>paxos-by-example(通过一个例子理解paxos算法): <a href="https://juejin.im/post/5d159590f265da1b86089a89" target="_blank" rel="noopener">https://juejin.im/post/5d159590f265da1b86089a89</a></p>
</li>
<li><p>Paxos Made Live: an amazing paper from Google describing the challenges of their Paxos implementation in Chubby: <a href="http://static.googleusercontent.com/media/research.google.com/en//archive/paxos_made_live.pdf" target="_blank" rel="noopener">http://static.googleusercontent.com/media/research.google.com/en//archive/paxos_made_live.pdf</a></p>
</li>
<li><p>A Quora thread explaining Paxos in a few different ways: <a href="https://www.quora.com/Distributed-Systems/What-is-a-simple-explanation-of-the-Paxos-algorithm" target="_blank" rel="noopener">https://www.quora.com/Distributed-Systems/What-is-a-simple-explanation-of-the-Paxos-algorithm</a></p>
</li>
<li><p>Raft - An Understandable Consensus Algorithm. Raft is another conensus algorithm designed for humans to understand, which if you can tell from the above wall of text might be a problem with Paxos. <a href="https://ramcloud.stanford.edu/raft.pdf" target="_blank" rel="noopener">https://ramcloud.stanford.edu/raft.pdf</a></p>
</li>
<li><p>左耳听风 - 推荐阅读：分布式数据调度相关论文: <a href="http://10-02.com/180118-32%20_%20%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87.html" target="_blank" rel="noopener">http://10-02.com/180118-32%20_%20%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87.html</a></p>
</li>
<li></li>
</ul>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
  </section>

  


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">sainpo.yxb</p>
  <div class="site-description motion-element" itemprop="description">码农|理工男|文青</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/mewishu" title="GitHub &rarr; https://github.com/mewishu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:xbyan88@163.com" title="E-Mail &rarr; mailto:xbyan88@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
  </div>



        </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sainpo.yxb</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">81k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:13</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.3.0</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>








        
      </div>
    </footer>

    

  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>
  <script src="/lib/reading_progress/reading_progress.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



  

  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  























  <script src="/js/local-search.js?v=7.3.0"></script>








<script>
if ($('body').find('div.pdf').length) {
  $.ajax({
    type: 'GET',
    url: '//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js',
    dataType: 'script',
    cache: true,
    success: function() {
      $('body').find('div.pdf').each(function(i, o) {
        PDFObject.embed($(o).attr('target'), $(o), {
          pdfOpenParams: {
            navpanes: 0,
            toolbar: 0,
            statusbar: 0,
            pagemode: 'thumbs',
            view: 'FitH'
          },
          PDFJS_URL: '/lib/pdf/web/viewer.html',
          height: $(o).attr('height') || '500px'
        });
      });
    },
  });
}
</script>





    


</body>
</html>
